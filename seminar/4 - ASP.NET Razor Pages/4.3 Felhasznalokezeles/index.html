<!DOCTYPE html><html lang="hu" class="no-js"><head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="Gábor Gincsai">
      
      
        <link rel="canonical" href="https://webportalok.github.io/webportalok/seminar/4%20-%20ASP.NET%20Razor%20Pages/4.3%20Felhasznalokezeles/">
      
      
        <link rel="prev" href="../4.2%20Main%20pages/">
      
      
        <link rel="next" href="../4.4%20Admin%20pages/">
      
      
        
      
      
      <link rel="icon" href="../../../favicon.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>4.3. Felhasználó kezelés - VIAUJV83 - Webportálok fejlesztése</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../css/timeago.css">
    
      <link rel="stylesheet" href="../../../extra-material-theme.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  <link href="../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"><script src="../../../assets/javascripts/glightbox.min.js"></script><style id="glightbox-style">
            html.glightbox-open { overflow: initial; height: 100%; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color); }
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color); }
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color); }
        </style></head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="aut" data-md-color-primary="aut" data-md-color-accent="red">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#43-felhasznalo-kezeles" class="md-skip">
          Kihagyás
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Élőfej">
    <a href="../../.." title="VIAUJV83 - Webportálok fejlesztése" class="md-header__button md-logo" aria-label="VIAUJV83 - Webportálok fejlesztése" data-md-component="logo">
      
  <img src="../../../logo-bme-aut.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            VIAUJV83 - Webportálok fejlesztése
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              4.3. Felhasználó kezelés
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="aut" data-md-color-primary="aut" data-md-color-accent="red" aria-label="Váltás sötét témára" type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Váltás sötét témára" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7M9 21v-1h6v1a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1m3-17a5 5 0 0 0-5 5c0 2.05 1.23 3.81 3 4.58V16h4v-2.42c1.77-.77 3-2.53 3-4.58a5 5 0 0 0-5-5"></path></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="red" data-md-color-accent="indigo" aria-label="Váltás világos témára" type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Váltás világos témára" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 0-7 7c0 2.38 1.19 4.47 3 5.74V17a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-2.26c1.81-1.27 3-3.36 3-5.74a7 7 0 0 0-7-7M9 21a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-1H9z"></path></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Keresés" placeholder="Keresés" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
      </label>
      <nav class="md-search__options" aria-label="Keresés">
        
        <button type="reset" class="md-search__icon md-icon" title="Törlés" aria-label="Törlés" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Keresés inicializálása
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/webportalok/webportalok" title="Főoldalra ugrás" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"></path></svg>
  </div>
  <div class="md-source__repository">
    webportalok
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Lapok" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../information/terms%20of%20use/" class="md-tabs__link">
          
  
  
  Tudnivalók

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../0%20-%20Adatbazis%20alapok/" class="md-tabs__link">
          
  
  
  Laborok

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../homework/01%20-%20Specifikacio/" class="md-tabs__link">
          
  
  
  Házi feladatok

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigáció" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="VIAUJV83 - Webportálok fejlesztése" class="md-nav__button md-logo" aria-label="VIAUJV83 - Webportálok fejlesztése" data-md-component="logo">
      
  <img src="../../../logo-bme-aut.png" alt="logo">

    </a>
    VIAUJV83 - Webportálok fejlesztése
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/webportalok/webportalok" title="Főoldalra ugrás" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"></path></svg>
  </div>
  <div class="md-source__repository">
    webportalok
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1">
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Tudnivalók
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Tudnivalók
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../information/terms%20of%20use/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Felhasználási feltételek
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../information/course/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Tárgy információk
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../information/requirements/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Házi feladat követelmények
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../information/contributing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Hozzájárulás az anyaghoz
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Laborok
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Laborok
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../0%20-%20Adatbazis%20alapok/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    MS SQL ADATBÁZIS ÉS EF ALAPOK
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../1%20-%20Tervezes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    1. Tervezés
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../2%20-%20Projekt%20struktura/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2. Project struktúra és adatmodell
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../3%20-%20Backend%20services/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    3. Kiinduló Backend
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_5" checked>
        
          
          <label class="md-nav__link" for="__nav_2_5" id="__nav_2_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    4. ASP.NET Razor Pages
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    4. ASP.NET Razor Pages
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../4.1%20Basics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    4.1. Projekt felépítése és alapok
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../4.2%20Main%20pages/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    4.2. Főbb oldalak létrehozása
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    4.3. Felhasználó kezelés
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    4.3. Felhasználó kezelés
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Tartalomjegyzék">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Tartalomjegyzék
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#identity-beallitasa" class="md-nav__link">
    <span class="md-ellipsis">
      
        Identity beállítása
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Identity beállítása">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#addidentitycore" class="md-nav__link">
    <span class="md-ellipsis">
      
        AddIdentityCore
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adddefaultidentity" class="md-nav__link">
    <span class="md-ellipsis">
      
        AddDefaultIdentity
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#addidentity" class="md-nav__link">
    <span class="md-ellipsis">
      
        AddIdentity
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#addidentityapiendpoints" class="md-nav__link">
    <span class="md-ellipsis">
      
        AddIdentityApiEndpoints
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#identity-defaultui-al" class="md-nav__link">
    <span class="md-ellipsis">
      
        Identity DefaultUI-al
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#identity-options" class="md-nav__link">
    <span class="md-ellipsis">
      
        Identity Options
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#identity-oldalak-letrehozasa" class="md-nav__link">
    <span class="md-ellipsis">
      
        Identity oldalak létrehozása
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Identity oldalak létrehozása">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#grafikus-felulet" class="md-nav__link">
    <span class="md-ellipsis">
      
        Grafikus felület
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#net-cli" class="md-nav__link">
    <span class="md-ellipsis">
      
        .NET CLI
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#egyedi-ui" class="md-nav__link">
    <span class="md-ellipsis">
      
        Egyedi UI
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Egyedi UI">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#validacios-hibak" class="md-nav__link">
    <span class="md-ellipsis">
      
        Validációs hibák
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sajat-email-sender" class="md-nav__link">
    <span class="md-ellipsis">
      
        Saját email sender
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#regisztracios-oldal-testreszabasa" class="md-nav__link">
    <span class="md-ellipsis">
      
        Regisztrációs oldal testreszabása
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#jogosultsag-ellenorzes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Jogosultság ellenőrzés
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Jogosultság ellenőrzés">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#kosaram-oldal-lathatosag" class="md-nav__link">
    <span class="md-ellipsis">
      
        Kosaram oldal láthatóság
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#admin-oldalak-lathatosaga" class="md-nav__link">
    <span class="md-ellipsis">
      
        Admin oldalak láthatósága
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#onallo-feladat-profil-oldalak-opcionalis" class="md-nav__link">
    <span class="md-ellipsis">
      
        Önálló feladat: Profil oldalak (opcionális)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Önálló feladat: Profil oldalak (opcionális)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#3rd-party-login" class="md-nav__link">
    <span class="md-ellipsis">
      
        3rd party login
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3rd party login">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#app-registration-gui" class="md-nav__link">
    <span class="md-ellipsis">
      
        App registration (GUI)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#app-registration-powershell" class="md-nav__link">
    <span class="md-ellipsis">
      
        App registration (powershell)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ms-auth-hozzaadasa-a-projekthez" class="md-nav__link">
    <span class="md-ellipsis">
      
        MS Auth hozzáadása a projekthez
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#onallo-feladat-externallogin-kiegeszitese" class="md-nav__link">
    <span class="md-ellipsis">
      
        Önálló feladat: ExternalLogin kiegészítése
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gdpr" class="md-nav__link">
    <span class="md-ellipsis">
      
        GDPR
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#migraciok-automatikus-futtatasa" class="md-nav__link">
    <span class="md-ellipsis">
      
        Migrációk automatikus futtatása
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../4.4%20Admin%20pages/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    4.4. Admin oldalak
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_6">
        
          
          <label class="md-nav__link" for="__nav_2_6" id="__nav_2_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    ASP.NET MVC
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    ASP.NET MVC
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../5%20-%20ASP.NET%20MVC/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    5. ASP.NET Core MVC
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_7">
        
          
          <label class="md-nav__link" for="__nav_2_7" id="__nav_2_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    6. Blazor WASM
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    6. Blazor WASM
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../6%20-%20Blazor%20WASM/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    6.1. Blazor WASM alapok
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3">
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Házi feladatok
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Házi feladatok
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../homework/01%20-%20Specifikacio/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Specifikáció készítése
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../homework/02%20-%20Nagy%20hazi%20feladat/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Nagyházi feladat készítése
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Tartalomjegyzék">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Tartalomjegyzék
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#identity-beallitasa" class="md-nav__link">
    <span class="md-ellipsis">
      
        Identity beállítása
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Identity beállítása">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#addidentitycore" class="md-nav__link">
    <span class="md-ellipsis">
      
        AddIdentityCore
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adddefaultidentity" class="md-nav__link">
    <span class="md-ellipsis">
      
        AddDefaultIdentity
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#addidentity" class="md-nav__link">
    <span class="md-ellipsis">
      
        AddIdentity
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#addidentityapiendpoints" class="md-nav__link">
    <span class="md-ellipsis">
      
        AddIdentityApiEndpoints
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#identity-defaultui-al" class="md-nav__link">
    <span class="md-ellipsis">
      
        Identity DefaultUI-al
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#identity-options" class="md-nav__link">
    <span class="md-ellipsis">
      
        Identity Options
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#identity-oldalak-letrehozasa" class="md-nav__link">
    <span class="md-ellipsis">
      
        Identity oldalak létrehozása
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Identity oldalak létrehozása">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#grafikus-felulet" class="md-nav__link">
    <span class="md-ellipsis">
      
        Grafikus felület
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#net-cli" class="md-nav__link">
    <span class="md-ellipsis">
      
        .NET CLI
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#egyedi-ui" class="md-nav__link">
    <span class="md-ellipsis">
      
        Egyedi UI
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Egyedi UI">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#validacios-hibak" class="md-nav__link">
    <span class="md-ellipsis">
      
        Validációs hibák
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sajat-email-sender" class="md-nav__link">
    <span class="md-ellipsis">
      
        Saját email sender
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#regisztracios-oldal-testreszabasa" class="md-nav__link">
    <span class="md-ellipsis">
      
        Regisztrációs oldal testreszabása
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#jogosultsag-ellenorzes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Jogosultság ellenőrzés
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Jogosultság ellenőrzés">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#kosaram-oldal-lathatosag" class="md-nav__link">
    <span class="md-ellipsis">
      
        Kosaram oldal láthatóság
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#admin-oldalak-lathatosaga" class="md-nav__link">
    <span class="md-ellipsis">
      
        Admin oldalak láthatósága
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#onallo-feladat-profil-oldalak-opcionalis" class="md-nav__link">
    <span class="md-ellipsis">
      
        Önálló feladat: Profil oldalak (opcionális)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Önálló feladat: Profil oldalak (opcionális)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#3rd-party-login" class="md-nav__link">
    <span class="md-ellipsis">
      
        3rd party login
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3rd party login">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#app-registration-gui" class="md-nav__link">
    <span class="md-ellipsis">
      
        App registration (GUI)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#app-registration-powershell" class="md-nav__link">
    <span class="md-ellipsis">
      
        App registration (powershell)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ms-auth-hozzaadasa-a-projekthez" class="md-nav__link">
    <span class="md-ellipsis">
      
        MS Auth hozzáadása a projekthez
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#onallo-feladat-externallogin-kiegeszitese" class="md-nav__link">
    <span class="md-ellipsis">
      
        Önálló feladat: ExternalLogin kiegészítése
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gdpr" class="md-nav__link">
    <span class="md-ellipsis">
      
        GDPR
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#migraciok-automatikus-futtatasa" class="md-nav__link">
    <span class="md-ellipsis">
      
        Migrációk automatikus futtatása
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
    <a href="https://github.com/webportalok/webportalok/edit/master/docs/seminar/4 - ASP.NET Razor Pages/4.3 Felhasznalokezeles/index.md" title="Oldal szerkesztése" class="md-content__button md-icon" rel="edit">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"></path></svg>
    </a>
  
  


<h1 id="43-felhasznalo-kezeles">4.3. Felhasználó kezelés<a class="headerlink" href="#43-felhasznalo-kezeles" title="Permanent link">¶</a></h1>
<p>Felhasználókezeléshez a legkézenfekvőbb megoldás ha nem saját implementációt készítenünk, ugyanis ez nagyon sok hibalehetőséget hordoz magában. Például a felhasználó jelszavának ténylegesen titkosított, nem visszafejthető (hashelést és saltot alkalmazó) módon történő tárolását vagy a harmadik fél általi autentikációs mechanizmusok kezelését.</p>
<p>Használjuk tehát az ASP.NET Core elterjedt és szinte bármilyen esetben jól alkalmazható ASP.NET Core Identity megoldását, amivel a fenti problémákat meg tudjuk oldani.</p>
<p>Az <a href="https://learn.microsoft.com/en-us/aspnet/core/security/authentication/identity?view=aspnetcore-10.0&amp;tabs=visual-studio">ASP.NET Identity hivatalos dokumentációját</a> is érdemes lehet átnézni.</p>
<h2 id="identity-beallitasa">Identity beállítása<a class="headerlink" href="#identity-beallitasa" title="Permanent link">¶</a></h2>
<p>Az ASP.NET Identity-t a <code>BookShop.Web.RazorPage</code> projektben is be kell állítani, hogy pontosan hogyan szeretnénk használni.</p>
<p>Az első lépés, az <em>Identity</em> hozzáadása amit sokféleképpen megtehetünk attól függően mit szeretnénk használni. Tekintsük is át a lehetőségeket.</p>
<h3 id="addidentitycore">AddIdentityCore<a class="headerlink" href="#addidentitycore" title="Permanent link">¶</a></h3>
<p>A felhasználókezeléshez szükséges legfontosabb szolgáltatásokat regisztrálja be egy default implementációval a DI-ba.</p>
<ul>
<li>Szükséges validátorok.</li>
<li><code>IUserConfirmation&lt;TUser&gt;</code>, ami azt ellenőrzi, hogy a felhasználó e-mail címe meg lett-e erősítve.</li>
<li><code>IdentityErrorDescriber</code> a felhasználókezelés során keletkező hibák leírása.</li>
<li><code>ClaimsPrincipalFactory</code>, amivel a <code>ClaimsPrincipal</code>-t hozza létre az adott felhasználóhoz.</li>
<li><code>UserManager</code>, ami a felhasználó kezeléshez nélkülözhetetlen metódusokat tartalmazza.</li>
</ul>
<details class="tip">
<summary>AddIdentityCore forráskódja mit állít be helyettünk</summary>
<div class="highlight"><span class="filename">IdentityServiceCollectionExtensions</span><pre><span></span><code><span class="k">public</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">IdentityBuilder</span><span class="w"> </span><span class="n">AddIdentityCore</span><span class="o">&lt;</span><span class="n">TUser</span><span class="o">&gt;</span><span class="p">(</span><span class="k">this</span><span class="w"> </span><span class="n">IServiceCollection</span><span class="w"> </span><span class="n">services</span><span class="p">,</span><span class="w"> </span><span class="n">Action</span><span class="o">&lt;</span><span class="n">IdentityOptions</span><span class="o">&gt;</span><span class="w"> </span><span class="n">setupAction</span><span class="p">)</span>
<span class="w">    </span><span class="k">where</span><span class="w"> </span><span class="n">TUser</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="k">class</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Services identity depends on</span>
<span class="w">    </span><span class="n">services</span><span class="p">.</span><span class="n">AddOptions</span><span class="p">().</span><span class="n">AddLogging</span><span class="p">();</span>
<span class="w">    </span><span class="n">services</span><span class="p">.</span><span class="n">AddMetrics</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Services used by identity</span>
<span class="w">    </span><span class="n">services</span><span class="p">.</span><span class="n">TryAddScoped</span><span class="o">&lt;</span><span class="n">IUserValidator</span><span class="o">&lt;</span><span class="n">TUser</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">UserValidator</span><span class="o">&lt;</span><span class="n">TUser</span><span class="o">&gt;&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="n">services</span><span class="p">.</span><span class="n">TryAddScoped</span><span class="o">&lt;</span><span class="n">IPasswordValidator</span><span class="o">&lt;</span><span class="n">TUser</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">PasswordValidator</span><span class="o">&lt;</span><span class="n">TUser</span><span class="o">&gt;&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="n">services</span><span class="p">.</span><span class="n">TryAddScoped</span><span class="o">&lt;</span><span class="n">IPasswordHasher</span><span class="o">&lt;</span><span class="n">TUser</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">PasswordHasher</span><span class="o">&lt;</span><span class="n">TUser</span><span class="o">&gt;&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="n">services</span><span class="p">.</span><span class="n">TryAddScoped</span><span class="o">&lt;</span><span class="n">ILookupNormalizer</span><span class="p">,</span><span class="w"> </span><span class="n">UpperInvariantLookupNormalizer</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="n">services</span><span class="p">.</span><span class="n">TryAddScoped</span><span class="o">&lt;</span><span class="n">IUserConfirmation</span><span class="o">&lt;</span><span class="n">TUser</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">DefaultUserConfirmation</span><span class="o">&lt;</span><span class="n">TUser</span><span class="o">&gt;&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// No interface for the error describer so we can add errors without rev'ing the interface</span>
<span class="w">    </span><span class="n">services</span><span class="p">.</span><span class="n">TryAddScoped</span><span class="o">&lt;</span><span class="n">IdentityErrorDescriber</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="n">services</span><span class="p">.</span><span class="n">TryAddScoped</span><span class="o">&lt;</span><span class="n">IUserClaimsPrincipalFactory</span><span class="o">&lt;</span><span class="n">TUser</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">UserClaimsPrincipalFactory</span><span class="o">&lt;</span><span class="n">TUser</span><span class="o">&gt;&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="n">services</span><span class="p">.</span><span class="n">TryAddScoped</span><span class="o">&lt;</span><span class="n">UserManager</span><span class="o">&lt;</span><span class="n">TUser</span><span class="o">&gt;&gt;</span><span class="p">();</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">setupAction</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">null</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">services</span><span class="p">.</span><span class="n">Configure</span><span class="p">(</span><span class="n">setupAction</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nf">IdentityBuilder</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">TUser</span><span class="p">),</span><span class="w"> </span><span class="n">services</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
</details>
<h3 id="adddefaultidentity">AddDefaultIdentity<a class="headerlink" href="#adddefaultidentity" title="Permanent link">¶</a></h3>
<p>Használatához szükséges a <code>Microsoft.AspNetCore.Identity.UI</code> NuGet package telepítése.  </p>
<p>Hozzáadja a leggyakoribb szolgáltatásokat, beleértve az alapértelmezett felhasználói felületet, a token szolgáltatókat, valamint konfigurálja a süti alapú hitelesítést, de a szerepkörök kezelését külön kell hozzáadni az <code>.AddRoles&lt;IdentityRole&lt;int&gt;&gt;()</code> meghívásával. Az alábbiakban látható, hogy pontosan mit állít be.</p>
<p>Nagyjából azt csinálja, mintha kézzel meghívnánk az <code>AddIdentityCore</code>, <code>AddDefaultUI</code>, <code>AddDefaultTokenProviders</code>-t.</p>
<p>Az <code>AddDefaultUI</code> teszi lehetővé, hogy az alapértelmezett Identity oldalakat használhassuk. Az egyes oldalak egy külön Razor Class Libraryben vannak, így a kódja nem érhető el, nem módosítható csak akkor ha legeneráljuk a megfelelő oldalat a mi kódunkba is, amit majd a későbbiekben bemutatott Scaffolding-gal tudunk megtenni.
A DefaultUI-hoz szükséges ehhez szükséges <code>SingInManager</code> és egy üres <code>IEmailSender</code> is regisztrációra kerül.</p>
<details class="tip">
<summary>AddDefaultIdentity forráskódja mit állít be helyettünk</summary>
<div class="highlight"><span class="filename">IdentityServiceCollectionUIExtensions</span><pre><span></span><code><span class="k">public</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">IdentityBuilder</span><span class="w"> </span><span class="n">AddDefaultIdentity</span><span class="o">&lt;</span><span class="n">TUser</span><span class="o">&gt;</span><span class="p">(</span><span class="k">this</span><span class="w"> </span><span class="n">IServiceCollection</span><span class="w"> </span><span class="n">services</span><span class="p">,</span><span class="w"> </span><span class="n">Action</span><span class="o">&lt;</span><span class="n">IdentityOptions</span><span class="o">&gt;</span><span class="w"> </span><span class="n">configureOptions</span><span class="p">)</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">TUser</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="k">class</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">services</span><span class="p">.</span><span class="n">AddAuthentication</span><span class="p">(</span><span class="n">o</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">o</span><span class="p">.</span><span class="n">DefaultScheme</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IdentityConstants</span><span class="p">.</span><span class="n">ApplicationScheme</span><span class="p">;</span>
<span class="w">        </span><span class="n">o</span><span class="p">.</span><span class="n">DefaultSignInScheme</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IdentityConstants</span><span class="p">.</span><span class="n">ExternalScheme</span><span class="p">;</span>
<span class="w">    </span><span class="p">}).</span><span class="n">AddIdentityCookies</span><span class="p">(</span><span class="n">o</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">services</span><span class="p">.</span><span class="n">AddIdentityCore</span><span class="o">&lt;</span><span class="n">TUser</span><span class="o">&gt;</span><span class="p">(</span><span class="n">o</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">o</span><span class="p">.</span><span class="n">Stores</span><span class="p">.</span><span class="n">MaxLengthForKeys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">128</span><span class="p">;</span>
<span class="w">        </span><span class="n">configureOptions</span><span class="o">?.</span><span class="n">Invoke</span><span class="p">(</span><span class="n">o</span><span class="p">);</span>
<span class="w">    </span><span class="p">}).</span><span class="n">AddDefaultUI</span><span class="p">().</span><span class="n">AddDefaultTokenProviders</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
</details>
<h3 id="addidentity">AddIdentity<a class="headerlink" href="#addidentity" title="Permanent link">¶</a></h3>
<p>Úgy konfigurálja fel az Identity-t, hogy minden részét használhassuk, ami persze nem biztos, hogy mindig kell.</p>
<ul>
<li>HttpContextAccessor</li>
<li>UserManager-en felül SingInManager és RoleManager.</li>
<li>3<sup>rd</sup> party login, 2FA autentikácó és a hozzá tartozó sütik.</li>
<li>Belépés pass key használatával.</li>
<li>Szerepkör kezelés beállítása.</li>
</ul>
<details class="tip">
<summary>AddIdentity forráskódja mit állít be helyettünk</summary>
<div class="highlight"><span class="filename">IdentityServiceCollectionExtensions</span><pre><span></span><code><span class="k">public</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">IdentityBuilder</span><span class="w"> </span><span class="n">AddIdentity</span><span class="o">&lt;</span><span class="n">TUser</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">DynamicallyAccessedMembers</span><span class="p">(</span><span class="n">DynamicallyAccessedMemberTypes</span><span class="p">.</span><span class="n">PublicConstructors</span><span class="p">)]</span><span class="w"> </span><span class="n">TRole</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">    </span><span class="k">this</span><span class="w"> </span><span class="n">IServiceCollection</span><span class="w"> </span><span class="n">services</span><span class="p">,</span>
<span class="w">    </span><span class="n">Action</span><span class="o">&lt;</span><span class="n">IdentityOptions</span><span class="o">&gt;</span><span class="w"> </span><span class="n">setupAction</span><span class="p">)</span>
<span class="w">    </span><span class="k">where</span><span class="w"> </span><span class="n">TUser</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="k">class</span>
<span class="w">    </span><span class="nc">where</span><span class="w"> </span><span class="n">TRole</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="k">class</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Services used by identity</span>
<span class="w">    </span><span class="n">services</span><span class="p">.</span><span class="n">AddAuthentication</span><span class="p">(</span><span class="n">options</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">options</span><span class="p">.</span><span class="n">DefaultAuthenticateScheme</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IdentityConstants</span><span class="p">.</span><span class="n">ApplicationScheme</span><span class="p">;</span>
<span class="w">        </span><span class="n">options</span><span class="p">.</span><span class="n">DefaultChallengeScheme</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IdentityConstants</span><span class="p">.</span><span class="n">ApplicationScheme</span><span class="p">;</span>
<span class="w">        </span><span class="n">options</span><span class="p">.</span><span class="n">DefaultSignInScheme</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IdentityConstants</span><span class="p">.</span><span class="n">ExternalScheme</span><span class="p">;</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">    </span><span class="p">.</span><span class="n">AddCookie</span><span class="p">(</span><span class="n">IdentityConstants</span><span class="p">.</span><span class="n">ApplicationScheme</span><span class="p">,</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">o</span><span class="p">.</span><span class="n">LoginPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PathString</span><span class="p">(</span><span class="s">"/Account/Login"</span><span class="p">);</span>
<span class="w">        </span><span class="n">o</span><span class="p">.</span><span class="n">Events</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CookieAuthenticationEvents</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">OnValidatePrincipal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SecurityStampValidator</span><span class="p">.</span><span class="n">ValidatePrincipalAsync</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">    </span><span class="p">.</span><span class="n">AddCookie</span><span class="p">(</span><span class="n">IdentityConstants</span><span class="p">.</span><span class="n">ExternalScheme</span><span class="p">,</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">o</span><span class="p">.</span><span class="n">Cookie</span><span class="p">.</span><span class="n">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IdentityConstants</span><span class="p">.</span><span class="n">ExternalScheme</span><span class="p">;</span>
<span class="w">        </span><span class="n">o</span><span class="p">.</span><span class="n">ExpireTimeSpan</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TimeSpan</span><span class="p">.</span><span class="n">FromMinutes</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">    </span><span class="p">.</span><span class="n">AddCookie</span><span class="p">(</span><span class="n">IdentityConstants</span><span class="p">.</span><span class="n">TwoFactorRememberMeScheme</span><span class="p">,</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">o</span><span class="p">.</span><span class="n">Cookie</span><span class="p">.</span><span class="n">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IdentityConstants</span><span class="p">.</span><span class="n">TwoFactorRememberMeScheme</span><span class="p">;</span>
<span class="w">        </span><span class="n">o</span><span class="p">.</span><span class="n">Events</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CookieAuthenticationEvents</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">OnValidatePrincipal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SecurityStampValidator</span><span class="p">.</span><span class="n">ValidateAsync</span><span class="o">&lt;</span><span class="n">ITwoFactorSecurityStampValidator</span><span class="o">&gt;</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">    </span><span class="p">.</span><span class="n">AddCookie</span><span class="p">(</span><span class="n">IdentityConstants</span><span class="p">.</span><span class="n">TwoFactorUserIdScheme</span><span class="p">,</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">o</span><span class="p">.</span><span class="n">Cookie</span><span class="p">.</span><span class="n">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IdentityConstants</span><span class="p">.</span><span class="n">TwoFactorUserIdScheme</span><span class="p">;</span>
<span class="w">        </span><span class="n">o</span><span class="p">.</span><span class="n">Events</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CookieAuthenticationEvents</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">OnRedirectToReturnUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Task</span><span class="p">.</span><span class="n">CompletedTask</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">        </span><span class="n">o</span><span class="p">.</span><span class="n">ExpireTimeSpan</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TimeSpan</span><span class="p">.</span><span class="n">FromMinutes</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Hosting doesn't add IHttpContextAccessor by default</span>
<span class="w">    </span><span class="n">services</span><span class="p">.</span><span class="n">AddHttpContextAccessor</span><span class="p">();</span>
<span class="w">    </span><span class="n">services</span><span class="p">.</span><span class="n">AddMetrics</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// Identity services</span>
<span class="w">    </span><span class="n">services</span><span class="p">.</span><span class="n">TryAddScoped</span><span class="o">&lt;</span><span class="n">IUserValidator</span><span class="o">&lt;</span><span class="n">TUser</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">UserValidator</span><span class="o">&lt;</span><span class="n">TUser</span><span class="o">&gt;&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="n">services</span><span class="p">.</span><span class="n">TryAddScoped</span><span class="o">&lt;</span><span class="n">IPasswordValidator</span><span class="o">&lt;</span><span class="n">TUser</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">PasswordValidator</span><span class="o">&lt;</span><span class="n">TUser</span><span class="o">&gt;&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="n">services</span><span class="p">.</span><span class="n">TryAddScoped</span><span class="o">&lt;</span><span class="n">IPasswordHasher</span><span class="o">&lt;</span><span class="n">TUser</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">PasswordHasher</span><span class="o">&lt;</span><span class="n">TUser</span><span class="o">&gt;&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="n">services</span><span class="p">.</span><span class="n">TryAddScoped</span><span class="o">&lt;</span><span class="n">ILookupNormalizer</span><span class="p">,</span><span class="w"> </span><span class="n">UpperInvariantLookupNormalizer</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="n">services</span><span class="p">.</span><span class="n">TryAddScoped</span><span class="o">&lt;</span><span class="n">IRoleValidator</span><span class="o">&lt;</span><span class="n">TRole</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">RoleValidator</span><span class="o">&lt;</span><span class="n">TRole</span><span class="o">&gt;&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// No interface for the error describer so we can add errors without rev'ing the interface</span>
<span class="w">    </span><span class="n">services</span><span class="p">.</span><span class="n">TryAddScoped</span><span class="o">&lt;</span><span class="n">IdentityErrorDescriber</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="n">services</span><span class="p">.</span><span class="n">TryAddScoped</span><span class="o">&lt;</span><span class="n">ISecurityStampValidator</span><span class="p">,</span><span class="w"> </span><span class="n">SecurityStampValidator</span><span class="o">&lt;</span><span class="n">TUser</span><span class="o">&gt;&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="n">services</span><span class="p">.</span><span class="n">TryAddEnumerable</span><span class="p">(</span><span class="n">ServiceDescriptor</span><span class="p">.</span><span class="n">Singleton</span><span class="o">&lt;</span><span class="n">IPostConfigureOptions</span><span class="o">&lt;</span><span class="n">SecurityStampValidatorOptions</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">PostConfigureSecurityStampValidatorOptions</span><span class="o">&gt;</span><span class="p">());</span>
<span class="w">    </span><span class="n">services</span><span class="p">.</span><span class="n">TryAddScoped</span><span class="o">&lt;</span><span class="n">ITwoFactorSecurityStampValidator</span><span class="p">,</span><span class="w"> </span><span class="n">TwoFactorSecurityStampValidator</span><span class="o">&lt;</span><span class="n">TUser</span><span class="o">&gt;&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="n">services</span><span class="p">.</span><span class="n">TryAddScoped</span><span class="o">&lt;</span><span class="n">IUserClaimsPrincipalFactory</span><span class="o">&lt;</span><span class="n">TUser</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">UserClaimsPrincipalFactory</span><span class="o">&lt;</span><span class="n">TUser</span><span class="p">,</span><span class="w"> </span><span class="n">TRole</span><span class="o">&gt;&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="n">services</span><span class="p">.</span><span class="n">TryAddScoped</span><span class="o">&lt;</span><span class="n">IUserConfirmation</span><span class="o">&lt;</span><span class="n">TUser</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">DefaultUserConfirmation</span><span class="o">&lt;</span><span class="n">TUser</span><span class="o">&gt;&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="n">services</span><span class="p">.</span><span class="n">TryAddScoped</span><span class="o">&lt;</span><span class="n">IPasskeyHandler</span><span class="o">&lt;</span><span class="n">TUser</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">PasskeyHandler</span><span class="o">&lt;</span><span class="n">TUser</span><span class="o">&gt;&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="n">services</span><span class="p">.</span><span class="n">TryAddScoped</span><span class="o">&lt;</span><span class="n">UserManager</span><span class="o">&lt;</span><span class="n">TUser</span><span class="o">&gt;&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="n">services</span><span class="p">.</span><span class="n">TryAddScoped</span><span class="o">&lt;</span><span class="n">SignInManager</span><span class="o">&lt;</span><span class="n">TUser</span><span class="o">&gt;&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="n">services</span><span class="p">.</span><span class="n">TryAddScoped</span><span class="o">&lt;</span><span class="n">RoleManager</span><span class="o">&lt;</span><span class="n">TRole</span><span class="o">&gt;&gt;</span><span class="p">();</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">setupAction</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">null</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">services</span><span class="p">.</span><span class="n">Configure</span><span class="p">(</span><span class="n">setupAction</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nf">IdentityBuilder</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">TUser</span><span class="p">),</span><span class="w"> </span><span class="k">typeof</span><span class="p">(</span><span class="n">TRole</span><span class="p">),</span><span class="w"> </span><span class="n">services</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
</details>
<h3 id="addidentityapiendpoints">AddIdentityApiEndpoints<a class="headerlink" href="#addidentityapiendpoints" title="Permanent link">¶</a></h3>
<p>Beállítja, hogy az autentikáció működjön bearer tokennel és sütivel is.</p>
<ul>
<li>Mint látható ez is a <code>AddIdentityCore</code>-t hívja a szükséges beállításokhoz, e miatt ez a megoldás sem állítja be alapértelmezés szerint a szerepkörök kezelését, amit a <code>.AddRoles&lt;IdentityRole&lt;int&gt;&gt;()</code> meghívásával tehetünk meg.</li>
<li>Az <code>AddApiEndpoints()</code> teszi lehetővé hogy a kódban használhassuk a <code>MapIdentityApi</code> ami egy minimal API a felhasználókezeléshez. Tipikusan akkor használjuk ha nem szerver oldalon renderelt alkalmazást készítünk (pl: Blazor WASM).</li>
</ul>
<details class="tip">
<summary>AddIdentityApiEndpoints forráskódja mit állít be helyettünk</summary>
<div class="highlight"><span class="filename">IdentityServiceCollectionExtensions</span><pre><span></span><code><span class="c1">/// Adds a set of common identity services to the application to support &lt;see cref="IdentityApiEndpointRouteBuilderExtensions.MapIdentityApi{TUser}(IEndpointRouteBuilder)"/&gt;</span>
<span class="c1">/// and configures authentication to support identity bearer tokens and cookies.</span>
<span class="k">public</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">IdentityBuilder</span><span class="w"> </span><span class="n">AddIdentityApiEndpoints</span><span class="o">&lt;</span><span class="n">TUser</span><span class="o">&gt;</span><span class="p">(</span><span class="k">this</span><span class="w"> </span><span class="n">IServiceCollection</span><span class="w"> </span><span class="n">services</span><span class="p">,</span><span class="w"> </span><span class="n">Action</span><span class="o">&lt;</span><span class="n">IdentityOptions</span><span class="o">&gt;</span><span class="w"> </span><span class="n">configure</span><span class="p">)</span>
<span class="w">    </span><span class="k">where</span><span class="w"> </span><span class="n">TUser</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">class</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">ArgumentNullException</span><span class="p">.</span><span class="n">ThrowIfNull</span><span class="p">(</span><span class="n">services</span><span class="p">);</span>
<span class="w">    </span><span class="n">ArgumentNullException</span><span class="p">.</span><span class="n">ThrowIfNull</span><span class="p">(</span><span class="n">configure</span><span class="p">);</span>

<span class="w">    </span><span class="n">services</span>
<span class="w">        </span><span class="p">.</span><span class="n">AddAuthentication</span><span class="p">(</span><span class="n">IdentityConstants</span><span class="p">.</span><span class="n">BearerAndApplicationScheme</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">AddScheme</span><span class="o">&lt;</span><span class="n">AuthenticationSchemeOptions</span><span class="p">,</span><span class="w"> </span><span class="n">CompositeIdentityHandler</span><span class="o">&gt;</span><span class="p">(</span><span class="n">IdentityConstants</span><span class="p">.</span><span class="n">BearerAndApplicationScheme</span><span class="p">,</span><span class="w"> </span><span class="k">null</span><span class="p">,</span><span class="w"> </span><span class="n">compositeOptions</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">compositeOptions</span><span class="p">.</span><span class="n">ForwardDefault</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IdentityConstants</span><span class="p">.</span><span class="n">BearerScheme</span><span class="p">;</span>
<span class="w">            </span><span class="n">compositeOptions</span><span class="p">.</span><span class="n">ForwardAuthenticate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IdentityConstants</span><span class="p">.</span><span class="n">BearerAndApplicationScheme</span><span class="p">;</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">        </span><span class="p">.</span><span class="n">AddBearerToken</span><span class="p">(</span><span class="n">IdentityConstants</span><span class="p">.</span><span class="n">BearerScheme</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">AddIdentityCookies</span><span class="p">();</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">services</span><span class="p">.</span><span class="n">AddIdentityCore</span><span class="o">&lt;</span><span class="n">TUser</span><span class="o">&gt;</span><span class="p">(</span><span class="n">configure</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">AddApiEndpoints</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>Illetve a minimal API végpontok használatához a <code>MapIdentityApi</code> meghívása is szükséges a megfelelő helyen.
<div class="highlight"><span class="filename">Program.cs</span><pre><span></span><code><span class="n">app</span><span class="p">.</span><span class="n">UseAuthentication</span><span class="p">();</span>
<span class="n">app</span><span class="p">.</span><span class="n">UseAuthorization</span><span class="p">();</span>

<span class="n">app</span><span class="p">.</span><span class="n">UseSession</span><span class="p">();</span>

<span class="hll"><span class="n">app</span><span class="p">.</span><span class="n">MapIdentityApi</span><span class="o">&lt;</span><span class="n">ApplicationUser</span><span class="o">&gt;</span><span class="p">();</span>
</span>
<span class="n">app</span><span class="p">.</span><span class="n">MapStaticAssets</span><span class="p">();</span>
<span class="n">app</span><span class="p">.</span><span class="n">MapRazorPages</span><span class="p">()</span>
<span class="p">.</span><span class="n">WithStaticAssets</span><span class="p">();</span>
</code></pre></div></li>
</ul>
</details>
<h2 id="identity-defaultui-al">Identity DefaultUI-al<a class="headerlink" href="#identity-defaultui-al" title="Permanent link">¶</a></h2>
<p>Felhasználói felületet még nem kaptunk a felhasználókezeléshez, viszont ezt sem kell kézzel megírni, mert Scaffolding segítségével létre tudunk hozni egy alapértelmezett implementációt.
Ahhoz, hogy tudjuk a Scaffoldingot használni a <code>BookShop.Web.RazorPage</code> projekthez adjuk hozzá a <code>Microsoft.VisualStudio.Web.CodeGeneration.Design</code> NuGet package-et.</p>
<ol>
<li>
<p>Állítsuk be úgy az Identity-t a lehető legegyszerűbb módon.</p>
<div class="highlight"><span class="filename">Program.cs</span><pre><span></span><code><span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddDbContext</span><span class="o">&lt;</span><span class="n">BookShopDbContext</span><span class="o">&gt;</span><span class="p">(</span><span class="n">options</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="n">UseSqlServer</span><span class="p">(</span><span class="n">connectionString</span><span class="p">));</span>

<span class="hll"><span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddDefaultIdentity</span><span class="o">&lt;</span><span class="n">ApplicationUser</span><span class="o">&gt;</span><span class="p">()</span>
</span><span class="hll"><span class="w">    </span><span class="p">.</span><span class="n">AddEntityFrameworkStores</span><span class="o">&lt;</span><span class="n">BookShopDbContext</span><span class="o">&gt;</span><span class="p">();</span>
</span></code></pre></div>
</li>
<li>
<p>Indítsuk el az alkalmazást és nyissuk meg a <code>/Identity/Account/Login</code> oldalt és azt fogjuk tapasztalni, hogy hiányzik a <code>_LoginPartial.cshtml</code> fájl.</p>
<figure>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="images/missing-loginPartial.png" data-desc-position="bottom"><img alt="Missing _LoginPartial" src="images/missing-loginPartial.png"></a></p>
<figcaption>
<p>Hiányzik a LoginPartial.cshtml</p>
</figcaption>
</figure>
</li>
<li>
<p>Hozzuk létre kézzel üres tartalommal a <em>Pages/Shared</em> könyvtárba. Fontos, hogy az <strong>Add New Item..</strong> -&gt; <strong>Razor View - Empty</strong>-t válasszuk ne a page-et, mert egy nem oldal, hanem csak egy view és mindenképpen <code>_LoginPartial.cshtml</code> nevet adjuk neki. A létrehozott fájt tartalmát törölhetjük.</p>
</li>
<li>
<p>Indítsuk el az alkalmazást és ismért nyissuk meg a <code>/Identity/Account/Login</code> oldalt és lépjünk be az admin felhasználóval</p>
<ul>
<li><a href="mailto:admin@example.com">admin@example.com</a></li>
<li>Password123!</li>
</ul>
</li>
<li>
<p>Ha mindent jól csináltunk be is tudunk lépni. Hasonlóan a <code>/Identity/Account/Logout</code> vagy a <code>/Identity/Account/Register</code> oldal is működik, de a fejlécben nincs belépés / regisztráció gomb, amit pont a _LoginPartial.cshtml feladata lenne megjeleníteni. Így a következő feladatunk, hogy ezeket az oldalakat valahogy legeneráljuk.</p>
</li>
</ol>
<h2 id="identity-options">Identity Options<a class="headerlink" href="#identity-options" title="Permanent link">¶</a></h2>
<p>Tegyünk egy kis kitérőt, és nézzük meg, hogy az Identity nyújtotta lehetőségeket hogyan tudjuk konfigurálni az <code>IdentityOptions</code> beállításaival. Ezt megtehetjük úgy, hogy az <code>AddDefaultIdentity</code> / <code>AddIdentity</code> / <code>AddIdentityCore</code>-nek adjuk át a beállítást, úgy ahogy eddig, vagy a <code>Configure&lt;IdentityOptions&gt;</code> függvényt használjuk.</p>
<p>Állítsuk be a jelszóra, kitiltása, felhasználóra és belépésre  vonatkató szabályokat. Az alábbiban láthatunk egy javasolt beállítást ezekre az adatokra, a biztonságot szem előtt tartva.</p>
<div class="highlight"><span class="filename">Program.cs</span><pre><span></span><code><span class="hll"><span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddDefaultIdentity</span><span class="p">(</span>
</span><span class="c1">// builder.Services.AddIdentityCore(</span>
<span class="c1">// builder.Services.AddIdentity&lt;ApplicationUser, IdentityRole&lt;int&gt;&gt;(</span>
<span class="n">options</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Password settings.</span>
<span class="w">    </span><span class="n">options</span><span class="p">.</span><span class="n">Password</span><span class="p">.</span><span class="n">RequiredLength</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">12</span><span class="p">;</span>
<span class="w">    </span><span class="n">options</span><span class="p">.</span><span class="n">Password</span><span class="p">.</span><span class="n">RequireNonAlphanumeric</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">;</span>
<span class="w">    </span><span class="n">options</span><span class="p">.</span><span class="n">Password</span><span class="p">.</span><span class="n">RequireUppercase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">;</span>
<span class="w">    </span><span class="n">options</span><span class="p">.</span><span class="n">Password</span><span class="p">.</span><span class="n">RequireLowercase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">;</span>
<span class="w">    </span><span class="n">options</span><span class="p">.</span><span class="n">Password</span><span class="p">.</span><span class="n">RequireDigit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">;</span>

<span class="w">    </span><span class="n">options</span><span class="p">.</span><span class="n">Password</span><span class="p">.</span><span class="n">RequiredUniqueChars</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Lockout settings.</span>
<span class="w">    </span><span class="n">options</span><span class="p">.</span><span class="n">Lockout</span><span class="p">.</span><span class="n">DefaultLockoutTimeSpan</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TimeSpan</span><span class="p">.</span><span class="n">FromMinutes</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="w">    </span><span class="n">options</span><span class="p">.</span><span class="n">Lockout</span><span class="p">.</span><span class="n">MaxFailedAccessAttempts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
<span class="w">    </span><span class="n">options</span><span class="p">.</span><span class="n">Lockout</span><span class="p">.</span><span class="n">AllowedForNewUsers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// User settings.</span>
<span class="w">    </span><span class="n">options</span><span class="p">.</span><span class="n">User</span><span class="p">.</span><span class="n">RequireUniqueEmail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">;</span>
<span class="w">    </span><span class="n">options</span><span class="p">.</span><span class="n">User</span><span class="p">.</span><span class="n">AllowedUserNameCharacters</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="s">"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-._@+"</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Sign‑in (only for production scenarios, for development you might want to disable these).</span>
<span class="w">    </span><span class="n">options</span><span class="p">.</span><span class="n">SignIn</span><span class="p">.</span><span class="n">RequireConfirmedAccount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">;</span>
<span class="w">    </span><span class="n">options</span><span class="p">.</span><span class="n">SignIn</span><span class="p">.</span><span class="n">RequireConfirmedEmail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">;</span>
<span class="p">})</span>
<span class="p">.</span><span class="n">AddEntityFrameworkStores</span><span class="o">&lt;</span><span class="n">BookShopDbContext</span><span class="o">&gt;</span><span class="p">()</span>
<span class="p">.</span><span class="n">AddDefaultTokenProviders</span><span class="p">();</span>
</code></pre></div>
<details class="tip">
<summary>A fenti beállítás a Configure<identityoptions>-t használva</identityoptions></summary>
<p>Ha ezt a megoldást használjuk akkor az <code>AddIdentity</code>-nél ne állítsuk be ezt.
</p><div class="highlight"><span class="filename">Program.cs</span><pre><span></span><code><span class="hll"><span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">Configure</span><span class="o">&lt;</span><span class="n">IdentityOptions</span><span class="o">&gt;</span><span class="p">(</span><span class="n">options</span><span class="w"> </span><span class="o">=&gt;</span>
</span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Password settings.</span>
<span class="w">    </span><span class="n">options</span><span class="p">.</span><span class="n">Password</span><span class="p">.</span><span class="n">RequiredLength</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">12</span><span class="p">;</span>
<span class="w">    </span><span class="n">options</span><span class="p">.</span><span class="n">Password</span><span class="p">.</span><span class="n">RequireNonAlphanumeric</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">;</span>
<span class="w">    </span><span class="n">options</span><span class="p">.</span><span class="n">Password</span><span class="p">.</span><span class="n">RequireUppercase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">;</span>
<span class="w">    </span><span class="n">options</span><span class="p">.</span><span class="n">Password</span><span class="p">.</span><span class="n">RequireLowercase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">;</span>
<span class="w">    </span><span class="n">options</span><span class="p">.</span><span class="n">Password</span><span class="p">.</span><span class="n">RequireDigit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">;</span>

<span class="w">    </span><span class="n">options</span><span class="p">.</span><span class="n">Password</span><span class="p">.</span><span class="n">RequiredUniqueChars</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Lockout settings.</span>
<span class="w">    </span><span class="n">options</span><span class="p">.</span><span class="n">Lockout</span><span class="p">.</span><span class="n">DefaultLockoutTimeSpan</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TimeSpan</span><span class="p">.</span><span class="n">FromMinutes</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="w">    </span><span class="n">options</span><span class="p">.</span><span class="n">Lockout</span><span class="p">.</span><span class="n">MaxFailedAccessAttempts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
<span class="w">    </span><span class="n">options</span><span class="p">.</span><span class="n">Lockout</span><span class="p">.</span><span class="n">AllowedForNewUsers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// User settings.</span>
<span class="w">    </span><span class="n">options</span><span class="p">.</span><span class="n">User</span><span class="p">.</span><span class="n">RequireUniqueEmail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">;</span>
<span class="w">    </span><span class="n">options</span><span class="p">.</span><span class="n">User</span><span class="p">.</span><span class="n">AllowedUserNameCharacters</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="s">"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-._@+"</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Sign‑in (only for production scenarios, for development you might want to disable these).</span>
<span class="w">    </span><span class="n">options</span><span class="p">.</span><span class="n">SignIn</span><span class="p">.</span><span class="n">RequireConfirmedAccount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">;</span>
<span class="w">    </span><span class="n">options</span><span class="p">.</span><span class="n">SignIn</span><span class="p">.</span><span class="n">RequireConfirmedEmail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">;</span><span class="w">      </span>
<span class="p">});</span>
</code></pre></div><p></p>
</details>
<h2 id="identity-oldalak-letrehozasa">Identity oldalak létrehozása<a class="headerlink" href="#identity-oldalak-letrehozasa" title="Permanent link">¶</a></h2>
<p>A fenti példában láttuk, hogy ha a <code>_LoginPartial.cshtml</code> megvan (akár üresen) akkor már működik a DefaultUI. Most a feladat az lenne, hogy legeneráljunk pár fontos oldalt, hogy azt szükség esetén testre tudjuk szabni.
Erre két módszer van. Használhatjuk a Visual Studio grafikus felületét, ami nem fog jó kódot generálni és sok manuális módosítás szükséges, vagy .NET CLI-ből is generálhatjuk, ahol kevesebb módosítás szükséges.</p>
<h3 id="grafikus-felulet">Grafikus felület<a class="headerlink" href="#grafikus-felulet" title="Permanent link">¶</a></h3>
<p>Visual Studioban az Idenetity-hez tartozó oldalakat le lehet generálni (scaffold), amit a Add -&gt; New Scaffolded item... segítségével tehetünk meg. Itt először ki kell választani, hogy az Identity oldalakat szeretnénk generálni, majd kiválasztani, hogy mely oldalakat szeretnénk és megadni, hogy melyik DbContext-et használja.</p>
<figure>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="images/select-identity-page-to-scaffold.png" data-desc-position="bottom"><img alt="Scaffold items" src="images/select-identity-page-to-scaffold.png"></a></p>
<figcaption>
<p>Identity oldalak</p>
</figcaption>
</figure>
<p>Ki lehet próbálni, hogy milyen kódot generál, de sajnálatos módon a generátor nem fogja megtalálni helyesen a <code>BookShopDbContext</code>-et és a generált kódban a saját <code>ApplicationUser</code> osztály helyett mindenhol az <code>IdentityUser</code>-t fogja használni, amit kézzel kellene mindenhol javítani.</p>
<p>Fontos viszont hogy ha kipróbáljuk és nem akarjuk mindenhol átírni, akkor töröljük az összes generált kódot</p>
<ul>
<li>Areas könyvtár teljes tartalmát</li>
<li>Ha létrehozza a <code>Pages/Shares/_LoginPartial.cshtml</code> akkor annak legalább a tartalmát.</li>
<li><code>Program.cs</code> fájlból a <code>using BookShop.Web.RazorPage.Areas.Identity.Data;</code> sort.</li>
</ul>
<h3 id="net-cli">.NET CLI<a class="headerlink" href="#net-cli" title="Permanent link">¶</a></h3>
<p>A másik megoldás, hogy a parancssorból a <code>aspnet-codegenerator</code> segítségével generáljuk ki az oldalakat.
Fontos, hogy a parancsot mindig a <code>BookShop.Web.RazorPage</code> projekt könyvtárából kell majd futtassuk!</p>
<ol>
<li>
<p>Ehhez telepítsük fel a <code>dotnet-aspnet-codegenerator</code> csomagot.</p>
<div class="highlight"><pre><span></span><code><span class="n">dotnet</span> <span class="n">tool</span> <span class="n">install</span> <span class="n">-g</span> <span class="n">dotnet-aspnet-codegenerator</span>
</code></pre></div>
</li>
<li>
<p>A <code>BookShop.Web.RazorPage</code> projekt könyvtárából kell majd futtassuk a parancsot a <code>--help</code> kapcsolóval, hogy lássuk milyen opciókat adhatunk meg.</p>
<div class="highlight"><pre><span></span><code><span class="n">dotnet</span> <span class="n">aspnet-codegenerator</span> <span class="n">identity</span> <span class="p">-</span><span class="n">-help</span> 
</code></pre></div>
</li>
<li>
<p>Futtassuk úgy a parancsot, hogy az alapértelmezett oldalakat szeretnénk használni. Ez legenerálja a <code>_LoginPartial.cshtml</code>-t is, viszont mivel ilyen fájlunk már van (bár csak üres tartalommal) szóval töröljük. Sajnos a <code>--force</code> kapcsolót, hogy felülírja a már létező fájlokat itt nem működik :(.</p>
<div class="highlight"><pre><span></span><code><span class="n">dotnet</span> <span class="n">aspnet-codegenerator</span> <span class="n">identity</span> <span class="n">-dc</span> <span class="n">BookShop</span><span class="p">.</span><span class="n">Dal</span><span class="p">.</span><span class="n">BookShopDbContext</span> <span class="n">-u</span> <span class="n">BookShop</span><span class="p">.</span><span class="n">Dal</span><span class="p">.</span><span class="n">Entities</span><span class="p">.</span><span class="n">ApplicationUser</span> <span class="p">-</span><span class="n">-useDefaultUI</span>
</code></pre></div>
</li>
<li>
<p>A létrehozott kód persze nem tökéletes, az alábbi javítások szükségesek, hogy működjön az alkalmazás
    Az <code>Ares/Identity/Data</code> könyvtárat töröljük, mert ide létrehoz egy új DbContext-et, amire nincs szükség és az <code>ApplicationUser</code> osztályt is létrehozza. Hiába adjuk meg a DbContext-et és a User osztály típusát nem találja meg a generátor. Bár azzal, hogy a User osztály típusának <code>-u</code> megadtuk a <code>BookShop.Dal.Entities.ApplicationUser</code> legalább jó névvel hivatkozik rá, így ha töröljük a fájlt minden probléma megoldódik :)</p>
<figure>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="images/identity-defaultUI-pages.png" data-desc-position="bottom"><img alt="Identity Default UI pages" src="images/identity-defaultUI-pages.png"></a></p>
<figcaption>
<p>Alapértelmezett UI-hoz generált oldalak</p>
</figcaption>
</figure>
</li>
<li>
<p>Ha ezzel elkészültünk, akkor már csak egy apróságot kell megtennünk, mégpedig a <code>_Layout</code> oldalra kitenni a Bejelentkezés és Regisztráció gombokat. Ehhez a Scaffolding elkészített nekünk egy <code>_LoginPartial</code> nézetet, és elegendő azt kitenni az oldalra, és az majd lekezelni, hogy éppen a Bejelentkezés vagy a Kijelentkezés gombot kell-e mutatni. A partial view-t a menüpontokat tartalmazó  lezáró tag mögé tegyük, hogy jobbra legyen igazítva.</p>
<div class="highlight"><span class="filename">_Layout.cshtml</span><pre><span></span><code><span class="nt">&lt;div</span><span class="w"> </span><span class="na">class=</span><span class="s">"navbar-collapse collapse d-sm-inline-flex justify-content-between"</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;ul</span><span class="w"> </span><span class="na">class=</span><span class="s">"navbar-nav flex-grow-1"</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;li</span><span class="w"> </span><span class="na">class=</span><span class="s">"nav-item"</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;a</span><span class="w"> </span><span class="na">class=</span><span class="s">"nav-link text-dark"</span><span class="w"> </span><span class="na">asp-area=</span><span class="s">""</span><span class="w"> </span><span class="na">asp-page=</span><span class="s">"/Index"</span><span class="nt">&gt;</span>Home<span class="nt">&lt;/a&gt;</span>
<span class="w">        </span><span class="nt">&lt;/li&gt;</span>
<span class="w">        </span>@*<span class="w"> </span>...<span class="w"> </span>*@
<span class="w">    </span><span class="nt">&lt;/ul&gt;</span>
<span class="hll"><span class="w">    </span><span class="nt">&lt;partial</span><span class="w"> </span><span class="na">name=</span><span class="s">"_LoginPartial"</span><span class="w"> </span><span class="nt">/&gt;</span>
</span><span class="nt">&lt;/div&gt;</span>
</code></pre></div>
</li>
<li>
<p>Így már megjelenik a Register és Login vagy a Logoff gombok is. Ha testre szeretnénk szabni, akkor a <code>_LoginPartial.cshtml</code>-ben tudjuk ezt megtenni.</p>
</li>
<li>
<p>Ha több oldalt is testre szeretnénk szabni, akkor azt úgy tehetjük meg, hogy a <code>--files</code> kapcsoló mögött felsoroljuk azokat idézőjelek között, pontosvesszővel elválasztva az oldalakat, amit le szeretnénk generáltatni. A lehetséges fájlneveket megkapjuk ha a <code>--listFiles</code> kapcsolóval futtatva a parancsot.</p>
<div class="highlight"><span class="filename">Leheséges fájlnevek listázása</span><pre><span></span><code><span class="n">dotnet</span> <span class="n">aspnet-codegenerator</span> <span class="n">identity</span> <span class="p">-</span><span class="n">-listFiles</span>
</code></pre></div>
<div class="highlight"><span class="filename">Register, Login... oldalak létrehozása</span><pre><span></span><code><span class="n">dotnet</span> <span class="n">aspnet-codegenerator</span> <span class="n">identity</span> <span class="n">-dc</span> <span class="n">BookShop</span><span class="p">.</span><span class="n">Dal</span><span class="p">.</span><span class="n">BookShopDbContext</span> <span class="n">-u</span> <span class="n">BookShop</span><span class="p">.</span><span class="n">Dal</span><span class="p">.</span><span class="n">Entities</span><span class="p">.</span><span class="n">ApplicationUser</span>  <span class="p">-</span><span class="n">-files</span> <span class="s2">"Account.Register;Account.Login;Account.Logout;Account.ConfirmEmail;Account._StatusMessage;Account.RegisterConfirmation"</span>
</code></pre></div>
</li>
</ol>
<h2 id="egyedi-ui">Egyedi UI<a class="headerlink" href="#egyedi-ui" title="Permanent link">¶</a></h2>
<p>Ha a Default UI-t használjuk akkor minden oldal elérhető akkor is ha nem szerepel az oldal a kódunkban. Tehát ha csak bizonyos oldalakat szeretnénk használni, akkor el kell engedni a Default UI használatát és a szükséges oldalakhoz kell igazítani a konfigurációt. Az előző lépésben ezeket az oldalakat generáltuk le:</p>
<ul>
<li><em>Account.Register</em>: Regisztrációs oldal, amit majd ki kell egészíteni a <code>DisplayName</code> tulajdonsággal.</li>
<li><em>Account.Login</em>: Bejelentkezés oldal</li>
<li><em>Account.Logout</em>: Kijelentkezés oldal</li>
<li>
<p><em>Account.RegisterConfirmation</em>: Ha a <code>options.SignIn.RequireConfirmedAccount = false</code>-ra van állítva, akkor nem használja ezt az oldalt, regisztráció után azonnal belépteti a felhasználót. Ha <code>true</code> az értéke akkor viszont erre az oldalra irányítja a felhasználót, ahol jelzi, hogy e-mailben megkapta a megerősítéshez szükséges adatokat.</p>
<details class="info">
<summary>Felületről is meg tudjuk erősíteni</summary>
<figure>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="images/register-confirmation-debug.png" data-desc-position="bottom"><img alt="alt text" src="images/register-confirmation-debug.png"></a></p>
<figcaption>
<p>A felületről is le tudjuk kattintani a megerősítést.</p>
</figcaption>
</figure>
</details>
<details class="warning" open="open">
<summary>Production környezetbe ezt kapcsoljuk ki</summary>
<p>Az <code>RegisterConfirmation.cshtml.cs</code>-ben az <code>OnGetAsync()</code> metódusban a <code>DisplayConfirmAccountLink = true;</code>-t kell módosítani, hogy ne jelenítse meg a jóváhagyás linket.</p>
</details>
</li>
<li>
<p><em>Account.ConfirmEmail</em>: Ezen az oldalon lehet megerősíteni az email címet, mert ennek az URL-jét küldi el emailben a felhasználónak regisztráció után.</p>
</li>
<li>
<p><em>Account._StatusMessage</em>: A ConfirmEmail használja.</p>
</li>
<li>
<p>Ha nincs szükség 2FA akkor elegendő az <code>AddIdentityCore</code> használata, de a <code>SingInManager</code>-t kézzel kell hozzáadni.</p>
<div class="highlight"><span class="filename">Program.cs</span><pre><span></span><code><span class="hll"><span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddIdentityCore</span><span class="o">&lt;</span><span class="n">ApplicationUser</span><span class="o">&gt;</span><span class="p">()</span>
</span><span class="w">    </span><span class="p">.</span><span class="n">AddRoles</span><span class="o">&lt;</span><span class="n">IdentityRole</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&gt;</span><span class="p">()</span>
<span class="hll"><span class="w">    </span><span class="p">.</span><span class="n">AddSignInManager</span><span class="p">()</span>
</span><span class="w">    </span><span class="p">.</span><span class="n">AddEntityFrameworkStores</span><span class="o">&lt;</span><span class="n">BookShopDbContext</span><span class="o">&gt;</span><span class="p">();</span>
</code></pre></div>
</li>
<li>
<p>Ha így elindítjuk az alkalmazást az betölt, de a Login és Register oldal is hibát dob</p>
<ul>
<li>
<p>a <strong>Login oldal</strong> hiányolja a külső belépéses sütiket.</p>
<details class="failure">
<summary>No sign-out authentication handlers are registered</summary>
<p>InvalidOperationException: No sign-out authentication handlers are registered. Did you forget to call AddAuthentication().AddCookie("Identity.External",...)?</p>
</details>
</li>
<li>
<p>a <strong>Register oldal</strong> pedig egy <code>IEmailSender</code> implementációt hiányol.  </p>
<details class="failure">
<summary>Unable to resolve service for IEmailSender</summary>
<p>InvalidOperationException: Unable to resolve service for type 'Microsoft.AspNetCore.Identity.UI.Services.IEmailSender' while attempting to activate 'BookShop.Web.RazorPage.Areas.Identity.Pages.Account.RegisterModel'.</p>
</details>
</li>
<li>
<p>A hibaüzenet szerencsére részletesen leírja, hogy mit kell még beállítani, így az alábbi kódrészlettel könnyen orvosolhatjuk a problémát:</p>
</li>
</ul>
<div class="highlight"><span class="filename">Program.cs</span><pre><span></span><code><span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddIdentityCore</span><span class="o">&lt;</span><span class="n">ApplicationUser</span><span class="o">&gt;</span><span class="p">()</span>
<span class="w">    </span><span class="p">.</span><span class="n">AddRoles</span><span class="o">&lt;</span><span class="n">IdentityRole</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&gt;</span><span class="p">()</span>
<span class="w">    </span><span class="p">.</span><span class="n">AddSignInManager</span><span class="p">()</span>
<span class="w">    </span><span class="p">.</span><span class="n">AddEntityFrameworkStores</span><span class="o">&lt;</span><span class="n">BookShopDbContext</span><span class="o">&gt;</span><span class="p">();</span>

<span class="hll"><span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddAuthentication</span><span class="p">()</span>
</span><span class="hll"><span class="w">    </span><span class="p">.</span><span class="n">AddCookie</span><span class="p">(</span><span class="n">IdentityConstants</span><span class="p">.</span><span class="n">ExternalScheme</span><span class="p">,</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="o">=&gt;</span>
</span><span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">o</span><span class="p">.</span><span class="n">Cookie</span><span class="p">.</span><span class="n">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IdentityConstants</span><span class="p">.</span><span class="n">ExternalScheme</span><span class="p">;</span>
<span class="w">        </span><span class="n">o</span><span class="p">.</span><span class="n">ExpireTimeSpan</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TimeSpan</span><span class="p">.</span><span class="n">FromMinutes</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
<span class="w">    </span><span class="p">});</span>

<span class="hll"><span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">TryAddTransient</span><span class="o">&lt;</span><span class="n">IEmailSender</span><span class="p">,</span><span class="w"> </span><span class="n">NoOpEmailSender</span><span class="o">&gt;</span><span class="p">();</span>
</span></code></pre></div>
</li>
<li>
<p>Ha nem szeretnénk a fentiek szerint küzdeni a beállításokkal akkor a legtutibb megoldás, ami mindent bekapcsol csak az <code>IEmailSender</code> implementációt kell beregisztrálni, hiszen ez az implementáció egyedi kell legyen. A későbbiekben készítünk is hozzá saját implementációt.</p>
<div class="highlight"><span class="filename">Program.cs</span><pre><span></span><code><span class="hll"><span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddIdentity</span><span class="o">&lt;</span><span class="n">ApplicationUser</span><span class="p">,</span><span class="w"> </span><span class="n">IdentityRole</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="w"> </span><span class="n">options</span><span class="w"> </span><span class="o">=&gt;</span>
</span><span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">options</span><span class="p">.</span><span class="n">SignIn</span><span class="p">.</span><span class="n">RequireConfirmedAccount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">false</span><span class="p">;</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">    </span><span class="p">.</span><span class="n">AddEntityFrameworkStores</span><span class="o">&lt;</span><span class="n">BookShopDbContext</span><span class="o">&gt;</span><span class="p">()</span>
<span class="hll"><span class="w">    </span><span class="p">.</span><span class="n">AddDefaultTokenProviders</span><span class="p">();</span>
</span>
<span class="hll"><span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">TryAddTransient</span><span class="o">&lt;</span><span class="n">IEmailSender</span><span class="p">,</span><span class="w"> </span><span class="n">NoOpEmailSender</span><span class="o">&gt;</span><span class="p">();</span>
</span></code></pre></div>
</li>
</ul>
<p>A fenti beállításokat használva már tényleg nem érjük el azokat az oldalakat, amiket nem generáltunk le.</p>
<h3 id="validacios-hibak">Validációs hibák<a class="headerlink" href="#validacios-hibak" title="Permanent link">¶</a></h3>
<ol>
<li>
<p>Ahhoz, hogy a validációs hibák illeszkedjenek a bootstrap stílushoz, meg kell adni, hogy a jquery validation a bootstrap-es CSS osztályokat (is-valid és is-invalid) használja. Ehhez készítsünk egy <code>validation.js</code> fájlt a <code>wwwroot/js</code> könyvtárban fájlt az alábbi tartalommal</p>
<div class="highlight"><span class="filename">validation.js</span><pre><span></span><code><span class="kd">var</span><span class="w"> </span><span class="nx">settings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">validClass</span><span class="o">:</span><span class="w"> </span><span class="s2">"is-valid"</span><span class="p">,</span>
<span class="w">    </span><span class="nx">errorClass</span><span class="o">:</span><span class="w"> </span><span class="s2">"is-invalid"</span>
<span class="p">};</span>

<span class="nx">$</span><span class="p">.</span><span class="nx">validator</span><span class="p">.</span><span class="nx">setDefaults</span><span class="p">(</span><span class="nx">settings</span><span class="p">);</span>
<span class="nx">$</span><span class="p">.</span><span class="nx">validator</span><span class="p">.</span><span class="nx">unobtrusive</span><span class="p">.</span><span class="nx">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">settings</span><span class="p">;</span>
</code></pre></div>
</li>
<li>
<p>Ezt követően már csak annyi dolgunk van, hogy a <code>_ValidationScriptsPartial.cshtml</code>-be hivatkozzuk be ezt a js fájlt is. Fontos, hogy a <code>Pages\Shares</code> alatt <strong>és</strong> az <code>Areas\Identity\Pages</code> könyvtárban is található 1-1 <code>_ValidationScriptsPartial.cshtml</code> fájl. Mind a kettőbe tegyük bele!</p>
<div class="highlight"><span class="filename">_ValidationScriptsPartial.cshtml</span><pre><span></span><code><span class="nt">&lt;script</span><span class="w"> </span><span class="na">src=</span><span class="s">"~/lib/jquery-validation/dist/jquery.validate.min.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;script</span><span class="w"> </span><span class="na">src=</span><span class="s">"~/lib/jquery-validation-unobtrusive/dist/jquery.validate.unobtrusive.min.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="hll"><span class="nt">&lt;script</span><span class="w"> </span><span class="na">src=</span><span class="s">"~/js/validation.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
</span></code></pre></div>
</li>
<li>
<p>Így már bootstrap alapú a validáció, viszont ha hiba van akkor az egész űrlap lentebb csúszik, hogy meg tudjon jelenni a hibaüzenet. Ezt kétféleképpen orvosolhatjuk.</p>
<ul>
<li>A legegyszerűbb megoldás, hogyha csak a kötelezőséget ellenőrzünk, akkor nem jelenítünk meg hibaüzenetet. Ehhez annyit kell tenni, hogy az űrlapon az egyes inputokhoz rendelt <code>&lt;span asp-validation-for</code> tageket kiszedjük. De sajnos ilyenkor az a hibaüzenet sem jelenik meg ami azt jelzi, ha érvénytelen az email cím.</li>
</ul>
<div class="highlight"><span class="filename">Login.cshtml</span><pre><span></span><code><span class="nt">&lt;div</span><span class="w"> </span><span class="na">class=</span><span class="s">"form-floating mb-3"</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;input</span><span class="w"> </span><span class="na">asp-for=</span><span class="s">"Input.Email"</span><span class="w"> </span><span class="na">class=</span><span class="s">"form-control"</span><span class="w"> </span><span class="na">autocomplete=</span><span class="s">"username"</span><span class="w"> </span><span class="na">aria-required=</span><span class="s">"true"</span><span class="w"> </span><span class="na">placeholder=</span><span class="s">"name@example.com"</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;label</span><span class="w"> </span><span class="na">asp-for=</span><span class="s">"Input.Email"</span><span class="w"> </span><span class="na">class=</span><span class="s">"form-label"</span><span class="nt">&gt;</span>Email<span class="nt">&lt;/label&gt;</span>
<span class="w">    </span><del class="critic"><span class="w"> </span><span class="nt">&lt;span</span><span class="w"> </span><span class="na">asp-validation-for=</span><span class="s">"Input.Email"</span><span class="w"> </span><span class="na">class=</span><span class="s">"text-danger"</span><span class="nt">&gt;&lt;/span&gt;</span><span class="w"> </span></del>
<span class="nt">&lt;/div&gt;</span>
</code></pre></div>
<ul>
<li>A másik megoldás, hogy kicsit nagyobb helyet hagyunk az egyes inputok között (mb-4) és az <code>invalid-tooltip</code> CSS osztályt használjuk egy kis testreszabással. Ez a <em>password</em> mezőn állítsuk be, és akkor mindkét validáció látszódik.</li>
</ul>
<div class="highlight"><span class="filename">Login.cshtml</span><pre><span></span><code><span class="hll"><span class="nt">&lt;div</span><span class="w"> </span><span class="na">class=</span><span class="s">"form-floating mb-4"</span><span class="nt">&gt;</span>
</span><span class="w">    </span><span class="nt">&lt;input</span><span class="w"> </span><span class="na">asp-for=</span><span class="s">"Input.Password"</span><span class="w"> </span><span class="na">class=</span><span class="s">"form-control"</span><span class="w"> </span><span class="na">autocomplete=</span><span class="s">"current-password"</span><span class="w"> </span><span class="na">aria-required=</span><span class="s">"true"</span><span class="w"> </span><span class="na">placeholder=</span><span class="s">"password"</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;label</span><span class="w"> </span><span class="na">asp-for=</span><span class="s">"Input.Password"</span><span class="w"> </span><span class="na">class=</span><span class="s">"form-label"</span><span class="nt">&gt;</span>Password<span class="nt">&lt;/label&gt;</span>
<span class="hll"><span class="w">    </span><span class="nt">&lt;span</span><span class="w"> </span><span class="na">asp-validation-for=</span><span class="s">"Input.Password"</span><span class="w"> </span><span class="na">class=</span><span class="s">"invalid-tooltip"</span><span class="nt">&gt;&lt;/span&gt;</span>
</span><span class="nt">&lt;/div&gt;</span>
</code></pre></div>
<div class="highlight"><span class="filename">site.css</span><pre><span></span><code><span class="p">.</span><span class="nc">invalid-tooltip</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">width</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
<span class="w">    </span><span class="k">margin-top</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">padding-top</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">padding-bottom</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">font-size</span><span class="p">:</span><span class="w"> </span><span class="mf">.75</span><span class="kt">rem</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</li>
</ol>
<details class="success">
<summary>Elkészült validációs hibák</summary>
<figure>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="images/validation-error.png" data-desc-position="bottom"><img alt="alt text" src="images/validation-error.png"></a></p>
<figcaption>
<p>A kétféle validációs hiba</p>
</figcaption>
</figure>
</details>
<h3 id="sajat-email-sender">Saját email sender<a class="headerlink" href="#sajat-email-sender" title="Permanent link">¶</a></h3>
<p>Email küldéséhez szükségünk van egy SMTP szerverre, ami lehet a google szolgáltatása is, vagy a fejlesztési célokra kitalált ál email küldő az <a href="https://ethereal.email/">Ethereal</a> is. A gyakorlaton mi ez utóbbit fogjuk használni, mert a regisztrációja nagyon egyszerű.</p>
<p>Nyissuk meg a böngészőben a <a href="https://ethereal.email/create">https://ethereal.email/create</a> oldalt és ott kattintsunk a <em>Create Ethereal Accont</em> gombra, ami azonnal létre is hozza a felhasználónkat, melynek adatai az alábbi ábrán látható. Figyelem, véletlen adatokkal hozza létre, így az adatok mindenkinél mások lehetnek!</p>
<figure>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="images/etheral-account.png" data-desc-position="bottom"><img alt="alt text" src="images/etheral-account.png"></a></p>
<figcaption>
<p>Etheral account adatai</p>
</figcaption>
</figure>
<p>Az ábrán látható adatokat kell megadni ahhoz, hogy email tudjunk küldeni ezzel az SMTP szolgáltatással. Ehhez először vegyünk fel egy osztályt EMailSettings névvel és az alábbi kóddal.</p>
<div class="highlight"><span class="filename">Settings/EmailSetting.cs</span><pre><span></span><code><span class="k">namespace</span><span class="w"> </span><span class="nn">BookShop.Web.RazorPage.Settings</span><span class="p">;</span>

<span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">EmailSettings</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="n">Mail</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">null</span><span class="o">!</span><span class="p">;</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="n">DisplayName</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">null</span><span class="o">!</span><span class="p">;</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="n">Password</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">null</span><span class="o">!</span><span class="p">;</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="n">Host</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">null</span><span class="o">!</span><span class="p">;</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">Port</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>A fenti osztály fogja tárolni az SMTP szervere beállításait, azonban a konkrét értékeket a config fájlba szeretnénk tárolni, így az <code>appsettings.Developement.json</code>-ba vegyük fel az alábbi részt. Az adatok az ethereal oldalról származnak. Fontos, hogy a saját adatainkkal töltsük fel a fájlt, mert egyébként nem fogjuk tudni az Ethereal oldalán megnézni az emaileket.</p>
<div class="highlight"><span class="filename">appsettings.Developement.json</span><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">"DetailedErrors"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">  </span><span class="nt">"Logging"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">"LogLevel"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">"Default"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Information"</span><span class="p">,</span>
<span class="w">      </span><span class="nt">"Microsoft.AspNetCore"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Warning"</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="hll"><span class="w">  </span><span class="nt">"EMailSettings"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">    </span><span class="nt">"Mail"</span><span class="p">:</span><span class="w"> </span><span class="s2">"hilbert57@ethereal.email"</span><span class="p">,</span>
</span><span class="hll"><span class="w">    </span><span class="nt">"DisplayName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Hilbert Blick"</span><span class="p">,</span>
</span><span class="hll"><span class="w">    </span><span class="nt">"Password"</span><span class="p">:</span><span class="w"> </span><span class="s2">"5czSsn3CmAsKjgyykP"</span><span class="p">,</span>
</span><span class="hll"><span class="w">    </span><span class="nt">"Host"</span><span class="p">:</span><span class="w"> </span><span class="s2">"smtp.ethereal.email"</span><span class="p">,</span>
</span><span class="hll"><span class="w">    </span><span class="nt">"Port"</span><span class="p">:</span><span class="w"> </span><span class="mi">587</span>
</span><span class="hll"><span class="w">  </span><span class="p">}</span>
</span><span class="p">}</span>
</code></pre></div>
<p>Ezt követően már csak az <code>IEmailSender</code> interfészt kell megvalósítani, hogy ténylegesen ki tudjuk küldeni a leveleket, amihez hozzuk létre az EmailSender osztályt az alábbi implementációval:</p>
<div class="highlight"><span class="filename">Services/EmailSender.cs</span><pre><span></span><code><span class="k">using</span><span class="w"> </span><span class="nn">BookShop.Web.RazorPage.Settings</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">Microsoft.AspNetCore.Identity.UI.Services</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">Microsoft.Extensions.Options</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">System.Net.Mail</span><span class="p">;</span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">BookShop.Web.RazorPage.Services</span><span class="p">;</span>

<span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nf">EmailSender</span><span class="p">(</span><span class="n">IOptions</span><span class="o">&lt;</span><span class="n">EmailSettings</span><span class="o">&gt;</span><span class="w"> </span><span class="n">emailSettingsOptions</span><span class="p">,</span><span class="w"> </span><span class="n">ILogger</span><span class="o">&lt;</span><span class="n">EmailSender</span><span class="o">&gt;</span><span class="w"> </span><span class="n">logger</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">IEmailSender</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="k">readonly</span><span class="w"> </span><span class="n">EmailSettings</span><span class="w"> </span><span class="n">emailSettings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">emailSettingsOptions</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="n">Task</span><span class="w"> </span><span class="nf">SendEmailAsync</span><span class="p">(</span><span class="kt">string</span><span class="w"> </span><span class="n">email</span><span class="p">,</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="n">subject</span><span class="p">,</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="n">htmlMessage</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SmtpClient</span><span class="p">(</span><span class="n">emailSettings</span><span class="p">.</span><span class="n">Host</span><span class="p">,</span><span class="w"> </span><span class="n">emailSettings</span><span class="p">.</span><span class="n">Port</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">EnableSsl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">,</span>
<span class="w">            </span><span class="n">Credentials</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="n">Net</span><span class="p">.</span><span class="n">NetworkCredential</span><span class="p">(</span><span class="n">emailSettings</span><span class="p">.</span><span class="n">Mail</span><span class="p">,</span><span class="w"> </span><span class="n">emailSettings</span><span class="p">.</span><span class="n">Password</span><span class="p">)</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MailAddress</span><span class="p">(</span><span class="n">emailSettings</span><span class="p">.</span><span class="n">Mail</span><span class="p">,</span><span class="w"> </span><span class="n">emailSettings</span><span class="p">.</span><span class="n">DisplayName</span><span class="p">,</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="n">Text</span><span class="p">.</span><span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">);</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MailAddress</span><span class="p">(</span><span class="n">email</span><span class="p">);</span>

<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MailMessage</span><span class="p">(</span><span class="k">from</span><span class="p">,</span><span class="w"> </span><span class="n">to</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">Body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">htmlMessage</span><span class="p">,</span>
<span class="w">            </span><span class="n">BodyEncoding</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="n">Text</span><span class="p">.</span><span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">,</span>
<span class="w">            </span><span class="n">IsBodyHtml</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">,</span>
<span class="w">            </span><span class="n">Subject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">subject</span><span class="p">,</span>
<span class="w">            </span><span class="n">SubjectEncoding</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="n">Text</span><span class="p">.</span><span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="n">SendMailAsync</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">logger</span><span class="p">.</span><span class="n">IsEnabled</span><span class="p">(</span><span class="n">LogLevel</span><span class="p">.</span><span class="n">Information</span><span class="p">))</span>
<span class="w">            </span><span class="n">logger</span><span class="p">.</span><span class="n">LogInformation</span><span class="p">(</span><span class="s">"Email sent to: {to}"</span><span class="p">,</span><span class="w"> </span><span class="n">to</span><span class="p">.</span><span class="n">Address</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>A Program.cs-ben állítsuk be, hogy az appsettings alapján töltse fel a EMailSettings osztályt, és a saját e-mail sender implementációnkat regisztráljuk be a DI-ba a <code>NoOpEmailSender</code> helyett.</p>
<div class="highlight"><span class="filename">Program.cs</span><pre><span></span><code><span class="c1">// builder.Services.TryAddTransient&lt;IEmailSender, NoOpEmailSender&gt;();</span>
<span class="hll"><span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">TryAddTransient</span><span class="o">&lt;</span><span class="n">IEmailSender</span><span class="p">,</span><span class="w"> </span><span class="n">EmailSender</span><span class="o">&gt;</span><span class="p">();</span>
</span>
<span class="c1">// Reads the email settings from the configuration and registers it in the DI container.</span>
<span class="hll"><span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">Configure</span><span class="o">&lt;</span><span class="n">EmailSettings</span><span class="o">&gt;</span><span class="p">(</span><span class="n">builder</span><span class="p">.</span><span class="n">Configuration</span><span class="p">.</span><span class="n">GetSection</span><span class="p">(</span><span class="s">"EMailSettings"</span><span class="p">));</span>
</span></code></pre></div>
<h2 id="regisztracios-oldal-testreszabasa">Regisztrációs oldal testreszabása<a class="headerlink" href="#regisztracios-oldal-testreszabasa" title="Permanent link">¶</a></h2>
<p>Ha kipróbáljuk a regisztrációs oldalt, az még nem működik, mert a <code>DisplayName</code>-et nem kérjük be a felületen.</p>
<ol>
<li>
<p>Nyissuk meg az <code>Areas.Identity.Pages.Account/Registe.cshtml.cs</code> fájlt és az <code>InputModel</code>-be vegyük fel a DisplayName-et, illetve az <code>OnPostAsync</code>-ba állítsuk is be.</p>
<div class="highlight"><span class="filename">Register.cshtml.cs - InputModel</span><pre><span></span><code><span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">InputModel</span>
<span class="p">{</span>
<span class="w">    </span><span class="na">[Required]</span>
<span class="w">    </span><span class="na">[EmailAddress]</span>
<span class="w">    </span><span class="na">[Display(Name = "Email")]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="n">Email</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>

<span class="hll"><span class="w">    </span><span class="na">[Required]</span>
</span><span class="hll"><span class="w">    </span><span class="na">[Display(Name = "Display name")]</span>
</span><span class="hll"><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="n">DisplayName</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
</span>
<span class="w">    </span><span class="na">[Required]</span>
<span class="w">    </span><span class="na">[StringLength(100, ErrorMessage = "The {0} must be at least {2} and at max {1} characters long.", MinimumLength = 6)]</span>
<span class="w">    </span><span class="na">[DataType(DataType.Password)]</span>
<span class="w">    </span><span class="na">[Display(Name = "Password")]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="n">Password</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="na">[DataType(DataType.Password)]</span>
<span class="w">    </span><span class="na">[Display(Name = "Confirm password")]</span>
<span class="w">    </span><span class="na">[Compare("Password", ErrorMessage = "The password and confirmation password do not match.")]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="n">ConfirmPassword</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>Figyeljük meg, hogy a modell osztályban az egyes tulajdonságok előtt lévő attibútumokkal állítjuk be, hogy melyik megző kütelező, vagy hogy a <code>ConfirmPassword</code> meg kell egyezzen a <code>Password</code>-del. Tehát attribútum alapú validációt használunk.</li>
</ul>
<div class="highlight"><span class="filename">Register.cshtml.cs - OnPostAsync</span><pre><span></span><code><span class="k">public</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="n">Task</span><span class="o">&lt;</span><span class="n">IActionResult</span><span class="o">&gt;</span><span class="w"> </span><span class="n">OnPostAsync</span><span class="p">(</span><span class="kt">string</span><span class="w"> </span><span class="n">returnUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">null</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">returnUrl</span><span class="w"> </span><span class="o">??=</span><span class="w"> </span><span class="n">Url</span><span class="p">.</span><span class="n">Content</span><span class="p">(</span><span class="s">"~/"</span><span class="p">);</span>
<span class="w">    </span><span class="n">ExternalLogins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">await</span><span class="w"> </span><span class="n">_signInManager</span><span class="p">.</span><span class="n">GetExternalAuthenticationSchemesAsync</span><span class="p">()).</span><span class="n">ToList</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ModelState</span><span class="p">.</span><span class="n">IsValid</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateUser</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// Set the display name for the user.</span>
<span class="hll"><span class="w">        </span><span class="n">user</span><span class="p">.</span><span class="n">DisplayName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Input</span><span class="p">.</span><span class="n">DisplayName</span><span class="p">;</span>
</span>
<span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="n">_userStore</span><span class="p">.</span><span class="n">SetUserNameAsync</span><span class="p">(</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">Input</span><span class="p">.</span><span class="n">Email</span><span class="p">,</span><span class="w"> </span><span class="n">CancellationToken</span><span class="p">.</span><span class="n">None</span><span class="p">);</span>
<span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="n">_emailStore</span><span class="p">.</span><span class="n">SetEmailAsync</span><span class="p">(</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">Input</span><span class="p">.</span><span class="n">Email</span><span class="p">,</span><span class="w"> </span><span class="n">CancellationToken</span><span class="p">.</span><span class="n">None</span><span class="p">);</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="n">_userManager</span><span class="p">.</span><span class="n">CreateAsync</span><span class="p">(</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">Input</span><span class="p">.</span><span class="n">Password</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// ...</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// If we got this far, something failed, redisplay form</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nf">Page</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>Sikeres validáció után hozzuk létre a felhasználót a <code>CreateUser</code>-re, majd ezt követően állítjuk be a <code>DisplayName</code>-et. Külön függvények segítik az <code>UserName</code> és <code>Email</code> beállítását, ami után a <code>_userManager.CreateAsync()</code> hozza ténylegesen létre a felhasználót a megadott jelszóval.</li>
</ul>
</li>
<li>
<p>Ezt követően a felülere is tegyük ki az email cím alá a szövegdobozt, amiben a felhasználó meg tudja adni a nevét.</p>
<div class="highlight"><span class="filename">Register.cshtml</span><pre><span></span><code><span class="nt">&lt;form</span><span class="w"> </span><span class="na">id=</span><span class="s">"registerForm"</span><span class="w"> </span><span class="na">asp-route-returnUrl=</span><span class="s">"@Model.ReturnUrl"</span><span class="w"> </span><span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;h2&gt;</span>Create<span class="w"> </span>a<span class="w"> </span>new<span class="w"> </span>account.<span class="nt">&lt;/h2&gt;</span>
<span class="w">    </span><span class="nt">&lt;hr</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;div</span><span class="w"> </span><span class="na">asp-validation-summary=</span><span class="s">"ModelOnly"</span><span class="w"> </span><span class="na">class=</span><span class="s">"text-danger"</span><span class="w"> </span><span class="na">role=</span><span class="s">"alert"</span><span class="nt">&gt;&lt;/div&gt;</span>
<span class="w">    </span><span class="nt">&lt;div</span><span class="w"> </span><span class="na">class=</span><span class="s">"form-floating mb-3"</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;input</span><span class="w"> </span><span class="na">asp-for=</span><span class="s">"Input.Email"</span><span class="w"> </span><span class="na">class=</span><span class="s">"form-control"</span><span class="w"> </span><span class="na">autocomplete=</span><span class="s">"username"</span><span class="w"> </span><span class="na">aria-required=</span><span class="s">"true"</span><span class="w"> </span><span class="na">placeholder=</span><span class="s">"name@example.com"</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;label</span><span class="w"> </span><span class="na">asp-for=</span><span class="s">"Input.Email"</span><span class="nt">&gt;</span>Email<span class="nt">&lt;/label&gt;</span>
<span class="w">        </span><span class="nt">&lt;span</span><span class="w"> </span><span class="na">asp-validation-for=</span><span class="s">"Input.Email"</span><span class="w"> </span><span class="na">class=</span><span class="s">"text-danger"</span><span class="nt">&gt;&lt;/span&gt;</span>
<span class="w">    </span><span class="nt">&lt;/div&gt;</span>
<span class="hll"><span class="w">    </span><span class="nt">&lt;div</span><span class="w"> </span><span class="na">class=</span><span class="s">"form-floating mb-3"</span><span class="nt">&gt;</span>
</span><span class="hll"><span class="w">        </span><span class="nt">&lt;input</span><span class="w"> </span><span class="na">asp-for=</span><span class="s">"Input.DisplayName"</span><span class="w"> </span><span class="na">class=</span><span class="s">"form-control"</span><span class="w"> </span><span class="na">aria-required=</span><span class="s">"true"</span><span class="w"> </span><span class="na">placeholder=</span><span class="s">""</span><span class="w"> </span><span class="nt">/&gt;</span>
</span><span class="hll"><span class="w">        </span><span class="nt">&lt;label</span><span class="w"> </span><span class="na">asp-for=</span><span class="s">"Input.DisplayName"</span><span class="nt">&gt;</span>Display<span class="w"> </span>name<span class="nt">&lt;/label&gt;</span>
</span><span class="hll"><span class="w">        </span><span class="nt">&lt;span</span><span class="w"> </span><span class="na">asp-validation-for=</span><span class="s">"Input.DisplayName"</span><span class="w"> </span><span class="na">class=</span><span class="s">"text-danger"</span><span class="nt">&gt;&lt;/span&gt;</span>
</span><span class="hll"><span class="w">    </span><span class="nt">&lt;/div&gt;</span>
</span><span class="w">    </span><span class="nt">&lt;div</span><span class="w"> </span><span class="na">class=</span><span class="s">"form-floating mb-3"</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;input</span><span class="w"> </span><span class="na">asp-for=</span><span class="s">"Input.Password"</span><span class="w"> </span><span class="na">class=</span><span class="s">"form-control"</span><span class="w"> </span><span class="na">autocomplete=</span><span class="s">"new-password"</span><span class="w"> </span><span class="na">aria-required=</span><span class="s">"true"</span><span class="w"> </span><span class="na">placeholder=</span><span class="s">"password"</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;label</span><span class="w"> </span><span class="na">asp-for=</span><span class="s">"Input.Password"</span><span class="nt">&gt;</span>Password<span class="nt">&lt;/label&gt;</span>
<span class="w">        </span><span class="nt">&lt;span</span><span class="w"> </span><span class="na">asp-validation-for=</span><span class="s">"Input.Password"</span><span class="w"> </span><span class="na">class=</span><span class="s">"text-danger"</span><span class="nt">&gt;&lt;/span&gt;</span>
<span class="w">    </span><span class="nt">&lt;/div&gt;</span>
<span class="w">    </span><span class="nt">&lt;div</span><span class="w"> </span><span class="na">class=</span><span class="s">"form-floating mb-3"</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;input</span><span class="w"> </span><span class="na">asp-for=</span><span class="s">"Input.ConfirmPassword"</span><span class="w"> </span><span class="na">class=</span><span class="s">"form-control"</span><span class="w"> </span><span class="na">autocomplete=</span><span class="s">"new-password"</span><span class="w"> </span><span class="na">aria-required=</span><span class="s">"true"</span><span class="w"> </span><span class="na">placeholder=</span><span class="s">"password"</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;label</span><span class="w"> </span><span class="na">asp-for=</span><span class="s">"Input.ConfirmPassword"</span><span class="nt">&gt;</span>Confirm<span class="w"> </span>Password<span class="nt">&lt;/label&gt;</span>
<span class="w">        </span><span class="nt">&lt;span</span><span class="w"> </span><span class="na">asp-validation-for=</span><span class="s">"Input.ConfirmPassword"</span><span class="w"> </span><span class="na">class=</span><span class="s">"text-danger"</span><span class="nt">&gt;&lt;/span&gt;</span>
<span class="w">    </span><span class="nt">&lt;/div&gt;</span>
<span class="w">    </span><span class="nt">&lt;button</span><span class="w"> </span><span class="na">id=</span><span class="s">"registerSubmit"</span><span class="w"> </span><span class="na">type=</span><span class="s">"submit"</span><span class="w"> </span><span class="na">class=</span><span class="s">"w-100 btn btn-lg btn-primary"</span><span class="nt">&gt;</span>Register<span class="nt">&lt;/button&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</code></pre></div>
</li>
<li>
<p>Próbáljuk ki az oldalt. Mivel a korábbiakban létrehoztuk Scaffoldinggal a <em>ConfirmEmail</em> és <em>_StatusMessage</em> oldalakat miden működni fog.<br>
Viszont ha megnézzük a <code>Register.cshtml.cs</code> fájlban a kódot, akkor azt vehetjük érszre, hogy akkor is legenerálja a jóváhagyáshoz szükséges linket (ami null lesz ha nincs a <em>ConfirmEmail</em> legenerálva), ha nem kell kiküldeni a megerősítést a felhasználónak.</p>
</li>
</ol>
<details class="tip">
<summary>Csak akkor generáljuk a jóváhagyó linket ha szükséges</summary>
<ul>
<li>A link generálást elég lenne akkor futtatni, ha tényleg ki kell küldeni a linket. Az alapérelmezett implementációban <code>DefaultUserConfirmation</code> a logika az, hogy a megerősített email nézi <code>IsEmailConfirmedAsync</code>. Tehát az egész email generálásos részt bele kell tenni az <code>if (_userManager.Options.SignIn.RequireConfirmedAccount)</code> alá.</li>
</ul>
<div class="highlight"><span class="filename">Register.cshtml.cs</span><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">Succeeded</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">_logger</span><span class="p">.</span><span class="n">LogInformation</span><span class="p">(</span><span class="s">"User created a new account with password."</span><span class="p">);</span>

<span class="hll"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_userManager</span><span class="p">.</span><span class="n">Options</span><span class="p">.</span><span class="n">SignIn</span><span class="p">.</span><span class="n">RequireConfirmedAccount</span><span class="p">)</span>
</span><span class="hll"><span class="w">    </span><span class="p">{</span>
</span><span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">userId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="n">_userManager</span><span class="p">.</span><span class="n">GetUserIdAsync</span><span class="p">(</span><span class="n">user</span><span class="p">);</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="n">_userManager</span><span class="p">.</span><span class="n">GenerateEmailConfirmationTokenAsync</span><span class="p">(</span><span class="n">user</span><span class="p">);</span>
<span class="w">        </span><span class="n">code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WebEncoders</span><span class="p">.</span><span class="n">Base64UrlEncode</span><span class="p">(</span><span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="n">GetBytes</span><span class="p">(</span><span class="n">code</span><span class="p">));</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">callbackUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Url</span><span class="p">.</span><span class="n">Page</span><span class="p">(</span>
<span class="w">            </span><span class="s">"/Account/ConfirmEmail"</span><span class="p">,</span>
<span class="w">            </span><span class="n">pageHandler</span><span class="p">:</span><span class="w"> </span><span class="k">null</span><span class="p">,</span>
<span class="w">            </span><span class="n">values</span><span class="p">:</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">area</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"Identity"</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">code</span><span class="p">,</span><span class="w"> </span><span class="n">returnUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">returnUrl</span><span class="w"> </span><span class="p">},</span>
<span class="w">            </span><span class="n">protocol</span><span class="p">:</span><span class="w"> </span><span class="n">Request</span><span class="p">.</span><span class="n">Scheme</span><span class="p">);</span>

<span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="n">_emailSender</span><span class="p">.</span><span class="n">SendEmailAsync</span><span class="p">(</span><span class="n">Input</span><span class="p">.</span><span class="n">Email</span><span class="p">,</span><span class="w"> </span><span class="s">"Confirm your email"</span><span class="p">,</span>
<span class="w">            </span><span class="s">$"Please confirm your account by &lt;a href='{HtmlEncoder.Default.Encode(callbackUrl)}'&gt;clicking here&lt;/a&gt;."</span><span class="p">);</span>

<span class="hll"><span class="w">    </span><span class="c1">// if (_userManager.Options.SignIn.RequireConfirmedAccount)</span>
</span><span class="hll"><span class="w">    </span><span class="c1">// {</span>
</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nf">RedirectToPage</span><span class="p">(</span><span class="s">"RegisterConfirmation"</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">email</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Input</span><span class="p">.</span><span class="n">Email</span><span class="p">,</span><span class="w"> </span><span class="n">returnUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">returnUrl</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="n">_signInManager</span><span class="p">.</span><span class="n">SignInAsync</span><span class="p">(</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">isPersistent</span><span class="p">:</span><span class="w"> </span><span class="k">false</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nf">LocalRedirect</span><span class="p">(</span><span class="n">returnUrl</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</details>
<ol>
<li>
<p>Regisztráljunk be egy új felhasználót az alábbi adatokkal</p>
<ul>
<li>email: <a href="mailto:test@example.com">test@example.com</a></li>
<li>displayName: Teszt Elek</li>
<li>password: Password123!</li>
</ul>
</li>
</ol>
<details class="success">
<summary>Sikeres regisztráció</summary>
<ol>
<li>
<p>Felhasználó létrehozása
<a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="images/register-new-user.png" data-desc-position="bottom"><img alt="Register new user" src="images/register-new-user.png"></a></p>
</li>
<li>
<p>Megerősítés szükséges. Csak ha be van kapcsolva a <code>options.SignIn.RequireConfirmedAccount = true</code> akkor ez az oldal fogad. Egyébként beléptet.
<a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="images/register-confirm.png" data-desc-position="bottom"><img alt="Confirm registration" src="images/register-confirm.png"></a></p>
</li>
<li>
<p>Megérkezik a megerősítő email
<a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="images/register-confirm-email-arrived.png" data-desc-position="bottom"><img alt="alt text" src="images/register-confirm-email-arrived.png"></a></p>
</li>
<li>
<p>Megerősítő email tartalma, benne a linkkel.
<a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="images/register-confirm-email-message.png" data-desc-position="bottom"><img alt="alt text" src="images/register-confirm-email-message.png"></a></p>
</li>
<li>
<p>Sikeres megerősítés
<a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="images/registration-confirmed-page.png" data-desc-position="bottom"><img alt="alt text" src="images/registration-confirmed-page.png"></a></p>
</li>
</ol>
</details>
<h2 id="jogosultsag-ellenorzes">Jogosultság ellenőrzés<a class="headerlink" href="#jogosultsag-ellenorzes" title="Permanent link">¶</a></h2>
<p>Azzal, hogy van felhasználó és jogosultság kezelésünk, már be tudjuk állítani, hogy egyes funkciók csak belépett felhasználóknak, vagy adott szerepkörnek legyenek csak elérhetők.</p>
<ol>
<li>
<p>Először a <code>Book.cshtml.cs</code> oldalon állítsuk be, hogy  a kosárba tételkor szerver oldalon ellenőrizzük, hogy be van-e lépve a felhasználó. Ha nincs akkor 401-el (UnAuthorized)-ot adjunk vissza.</p>
<div class="highlight"><span class="filename">Book.cshtml.cs</span><pre><span></span><code><span class="k">public</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="n">Task</span><span class="o">&lt;</span><span class="n">IActionResult</span><span class="o">&gt;</span><span class="w"> </span><span class="n">OnPostAddToCartAsync</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">bookId</span><span class="p">)</span><span class="w"> </span>
<span class="p">{</span>
<span class="hll"><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">User</span><span class="p">.</span><span class="n">Identity</span><span class="o">?.</span><span class="n">IsAuthenticated</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">true</span><span class="p">)</span>
</span><span class="hll"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nf">Unauthorized</span><span class="p">();</span>
</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div>
</li>
<li>
<p>Ugyanezt állítsuk be a komment létrehozásánál is.</p>
<div class="highlight"><span class="filename">Book.cshtml.cs</span><pre><span></span><code><span class="k">public</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="n">Task</span><span class="o">&lt;</span><span class="n">IActionResult</span><span class="o">&gt;</span><span class="w"> </span><span class="n">OnPostCreateCommentAsync</span><span class="p">()</span>
<span class="p">{</span>
<span class="hll"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">User</span><span class="p">.</span><span class="n">Identity</span><span class="o">?.</span><span class="n">IsAuthenticated</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">true</span><span class="p">)</span>
</span><span class="hll"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nf">Unauthorized</span><span class="p">();</span>
</span>
<span class="w">    </span><span class="c1">// ..</span>
<span class="p">}</span>
</code></pre></div>
</li>
<li>
<p>Próbáljuk ki, hogy tényleg hibaoldalt kapunk.</p>
</li>
<li>
<p>Rejtsük el a gombokat (új komment, kosárba és új ajánló), ha nincs belépve a felhasználó.</p>
<div class="highlight"><span class="filename">Book.cshml - Kosárba</span><pre><span></span><code><span class="hll">@if<span class="w"> </span>(User.Identity?.IsAuthenticated<span class="w"> </span>==<span class="w"> </span>true)
</span>{
<span class="w">    </span><span class="nt">&lt;form</span><span class="w"> </span><span class="na">asp-page-handler=</span><span class="s">"AddToCart"</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;input</span><span class="w"> </span><span class="na">type=</span><span class="s">"hidden"</span><span class="w"> </span><span class="na">name=</span><span class="s">"bookId"</span><span class="w"> </span><span class="na">value=</span><span class="s">"@Model.Book.Id"</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;button</span><span class="w"> </span><span class="na">class=</span><span class="s">"btn btn-outline-primary"</span><span class="nt">&gt;</span>Korárba<span class="nt">&lt;/button&gt;</span>
<span class="w">    </span><span class="nt">&lt;/form&gt;</span>
}
</code></pre></div>
<div class="highlight"><span class="filename">Book.cshml - Új ajánló</span><pre><span></span><code><span class="hll">@if<span class="w"> </span>(User.Identity?.IsAuthenticated<span class="w"> </span>==<span class="w"> </span>true)
</span>{
<span class="w">    </span><span class="nt">&lt;a</span><span class="w"> </span><span class="na">asp-page=</span><span class="s">"CreateComment"</span><span class="w"> </span><span class="na">asp-route-bookId=</span><span class="s">"@Model.Book.Id"</span><span class="nt">&gt;</span>Új<span class="w"> </span>ajánló<span class="w"> </span>írása<span class="w"> </span><span class="ni">&amp;raquo;</span><span class="nt">&lt;/a&gt;</span>
}
</code></pre></div>
<div class="highlight"><span class="filename">Book.cshml - Új komment</span><pre><span></span><code><span class="hll">@if<span class="w"> </span>(User.Identity?.IsAuthenticated<span class="w"> </span>==<span class="w"> </span>true)
</span><span class="hll">{
</span><span class="w">    </span><span class="nt">&lt;form</span><span class="w"> </span><span class="na">asp-page-handler=</span><span class="s">"CreateComment"</span><span class="nt">&gt;</span>
<span class="w">        </span>@*<span class="w"> </span>Hidden<span class="w"> </span>field<span class="w"> </span>bound<span class="w"> </span>to<span class="w"> </span>NewComment.BookId<span class="w"> </span>so<span class="w"> </span>it<span class="w"> </span>will<span class="w"> </span>be<span class="w"> </span>set<span class="w"> </span>for<span class="w"> </span>the<span class="w"> </span>click<span class="w"> </span>handler.<span class="w"> </span>*@
<span class="w">        </span><span class="nt">&lt;input</span><span class="w"> </span><span class="na">type=</span><span class="s">"hidden"</span><span class="w"> </span><span class="na">asp-for=</span><span class="s">"NewComment.BookId"</span><span class="w"> </span><span class="nt">/&gt;</span>

<span class="w">        </span><span class="nt">&lt;div</span><span class="w"> </span><span class="na">class=</span><span class="s">"d-flex"</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;div</span><span class="w"> </span><span class="na">class=</span><span class="s">"d-flex flex-column align-items-center flex-shrink-0 me-3"</span><span class="nt">&gt;</span>
<span class="w">                </span><span class="nt">&lt;i</span><span class="w"> </span><span class="na">class=</span><span class="s">"bi bi-person-square fs-1"</span><span class="nt">&gt;&lt;/i&gt;</span>
<span class="w">                </span><span class="nt">&lt;div</span><span class="w"> </span><span class="na">class=</span><span class="s">"text-muted"</span><span class="nt">&gt;</span>@(DateTime.Now.ToShortDateString())<span class="nt">&lt;/div&gt;</span>
<span class="w">                </span><span class="nt">&lt;div</span><span class="w"> </span><span class="na">class=</span><span class="s">"text-muted"</span><span class="nt">&gt;</span>@(DateTime.Now.ToShortTimeString())<span class="nt">&lt;/div&gt;</span>
<span class="w">            </span><span class="nt">&lt;/div&gt;</span>

<span class="w">            </span><span class="nt">&lt;textarea</span><span class="w"> </span><span class="na">class=</span><span class="s">"w-100"</span><span class="w"> </span><span class="na">rows=</span><span class="s">"3"</span><span class="w"> </span><span class="na">asp-for=</span><span class="s">"NewComment.Text"</span><span class="nt">&gt;&lt;/textarea&gt;</span>
<span class="w">        </span><span class="nt">&lt;/div&gt;</span>

<span class="w">        </span><span class="nt">&lt;div</span><span class="w"> </span><span class="na">class=</span><span class="s">"d-flex justify-content-end my-2"</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;button</span><span class="w"> </span><span class="na">type=</span><span class="s">"submit"</span><span class="w"> </span><span class="na">class=</span><span class="s">"btn btn-outline-primary"</span><span class="nt">&gt;</span>Hozzászólok<span class="nt">&lt;/button&gt;</span>
<span class="w">        </span><span class="nt">&lt;/div&gt;</span>
<span class="w">    </span><span class="nt">&lt;/form&gt;</span>
<span class="hll">}
</span><span class="hll">else
</span><span class="hll">{
</span><span class="hll"><span class="w">    </span><span class="nt">&lt;div&gt;</span>Komment<span class="w"> </span>írásához<span class="w"> </span>be<span class="w"> </span>kell<span class="w"> </span>jelentkezned!<span class="nt">&lt;/div&gt;</span>
</span><span class="hll">}
</span></code></pre></div>
</li>
<li>
<p>Ezt követően már a gombok sem látszódnak.</p>
</li>
</ol>
<h3 id="kosaram-oldal-lathatosag">Kosaram oldal láthatóság<a class="headerlink" href="#kosaram-oldal-lathatosag" title="Permanent link">¶</a></h3>
<p>Tüntessük el a kosaram oldal linkjét is ha nincs belépve a felhasználó.</p>
<ol>
<li>
<p>A <code>_Layout.cshtml</code> oldalon rejtsük el a menüpontot ha nincs belépve a felhasználó.</p>
<div class="highlight"><span class="filename">_Layout.cshtml</span><pre><span></span><code>@if(<span class="w"> </span>User.Identity?.IsAuthenticated<span class="w"> </span>==<span class="w"> </span>true<span class="w"> </span>)
{
<span class="w">    </span><span class="nt">&lt;li</span><span class="w"> </span><span class="na">class=</span><span class="s">"nav-item position-relative"</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;a</span><span class="w"> </span><span class="na">class=</span><span class="s">"nav-link text-dark"</span><span class="w"> </span><span class="na">asp-area=</span><span class="s">""</span><span class="w"> </span><span class="na">asp-page=</span><span class="s">"/Cart"</span><span class="nt">&gt;</span>
<span class="w">            </span>Kosaram
<span class="w">            </span>@if<span class="w"> </span>(Context.Session.Get<span class="nt">&lt;List&lt;CartItem&gt;</span>&gt;(BookShopConstants.CartSessionKey)?.Any()<span class="w"> </span>==<span class="w"> </span>true)
<span class="w">            </span>{
<span class="w">                </span><span class="nt">&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">"position-absolute start-100 translate-middle badge rounded-pill bg-danger"</span><span class="nt">&gt;</span>
<span class="w">                    </span>@(Context.Session.Get<span class="nt">&lt;List&lt;CartItem&gt;</span>&gt;(BookShopConstants.CartSessionKey)?.Sum(x<span class="w"> </span>=&gt;<span class="w"> </span>x.Count)<span class="w"> </span>??<span class="w"> </span>0)
<span class="w">                    </span><span class="nt">&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">"visually-hidden"</span><span class="nt">&gt;</span>elem<span class="w"> </span>a<span class="w"> </span>kosárban<span class="nt">&lt;/span&gt;</span>
<span class="w">                </span><span class="nt">&lt;/span&gt;</span>
<span class="w">            </span>}
<span class="w">        </span><span class="nt">&lt;/a&gt;</span>
<span class="w">    </span><span class="nt">&lt;/li&gt;</span>
}
</code></pre></div>
</li>
<li>
<p>A code behind-ban is védjük le, hogy csak belépett felhasználó hívhassa. Itt már használhatjuk az <code>[Authorize]</code> attribútumot, mert az egész oldalt nem kell elérni.
    </p><div class="highlight"><span class="filename">Cart.cshtml.cs</span><pre><span></span><code><span class="na">[Authorize]</span>
<span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nf">CartModel</span><span class="p">(</span><span class="n">IBookService</span><span class="w"> </span><span class="n">bookService</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">PageModel</span>
</code></pre></div><p></p>
</li>
</ol>
<h3 id="admin-oldalak-lathatosaga">Admin oldalak láthatósága<a class="headerlink" href="#admin-oldalak-lathatosaga" title="Permanent link">¶</a></h3>
<p>Az alkalmazáshoz, különbőző feltöltő és szerkesztő oldalakat is kell készíteni a könyvekhez, kategóriákhoz, vagy akár a felhasználólókhoz. Annak érdekében, hogy ezeknem az "Admin" oldalaknak a jogosultság kezelését egyszerűen tudjuk beállítani egy új módszerrel ismerkedünk meg.</p>
<ol>
<li>
<p>Először a layout oldalra a navigációs menübe vegyük fel a <em>Kategóriák szerkesztése</em>, <em>Könyvek szerkesztése</em>, <em>Felhasználók kezelése</em> linkeket. Azonban mivel ez sok helyet foglal tegyük az egészet az Adminisztráció legördülőbe. Ehhez az alábbiak szerint módosítsuk a layout oldalt.</p>
<div class="highlight"><span class="filename">_Layout.cshtml</span><pre><span></span><code><span class="nt">&lt;ul</span><span class="w"> </span><span class="na">class=</span><span class="s">"navbar-nav flex-grow-1"</span><span class="nt">&gt;</span>
<span class="w">    </span>@*<span class="w"> </span>Other<span class="w"> </span>links<span class="w"> </span>*@

<span class="hll"><span class="w">    </span>@if<span class="w"> </span>(User.IsInRole("Admin"))
</span><span class="hll"><span class="w">    </span>{
</span><span class="hll"><span class="w">        </span><span class="nt">&lt;li</span><span class="w"> </span><span class="na">class=</span><span class="s">"nav-item dropdown"</span><span class="nt">&gt;</span>
</span><span class="hll"><span class="w">            </span><span class="nt">&lt;a</span><span class="w"> </span><span class="na">class=</span><span class="s">"nav-link dropdown-toggle"</span><span class="w"> </span><span class="na">href=</span><span class="s">"#"</span><span class="w"> </span><span class="na">id=</span><span class="s">"navbarAdmin"</span><span class="w"> </span><span class="na">role=</span><span class="s">"button"</span><span class="w"> </span><span class="na">data-bs-toggle=</span><span class="s">"dropdown"</span><span class="w"> </span><span class="na">aria-expanded=</span><span class="s">"false"</span><span class="nt">&gt;</span>
</span><span class="hll"><span class="w">                </span>Adminisztráció
</span><span class="hll"><span class="w">            </span><span class="nt">&lt;/a&gt;</span>
</span><span class="hll"><span class="w">            </span><span class="nt">&lt;ul</span><span class="w"> </span><span class="na">class=</span><span class="s">"dropdown-menu"</span><span class="w"> </span><span class="na">aria-labelledby=</span><span class="s">"navbarAdmin"</span><span class="nt">&gt;</span>
</span><span class="hll"><span class="w">                </span><span class="nt">&lt;li&gt;</span>
</span><span class="hll"><span class="w">                    </span><span class="nt">&lt;a</span><span class="w"> </span><span class="na">class=</span><span class="s">"dropdown-item"</span><span class="w"> </span><span class="na">asp-area=</span><span class="s">""</span><span class="w"> </span><span class="na">asp-page=</span><span class="s">"/Admin/ManageCategories"</span><span class="nt">&gt;</span>Kategóriák<span class="nt">&lt;/a&gt;</span>
</span><span class="hll"><span class="w">                </span><span class="nt">&lt;/li&gt;</span>
</span><span class="hll"><span class="w">                </span><span class="nt">&lt;li&gt;</span>
</span><span class="hll"><span class="w">                    </span><span class="nt">&lt;a</span><span class="w"> </span><span class="na">class=</span><span class="s">"dropdown-item"</span><span class="w"> </span><span class="na">asp-area=</span><span class="s">""</span><span class="w"> </span><span class="na">asp-page=</span><span class="s">"/Admin/ManageBooks"</span><span class="nt">&gt;</span>Könyvek<span class="nt">&lt;/a&gt;</span>
</span><span class="hll"><span class="w">                </span><span class="nt">&lt;/li&gt;</span>
</span><span class="hll"><span class="w">                </span><span class="nt">&lt;li&gt;</span>
</span><span class="hll"><span class="w">                    </span><span class="nt">&lt;hr</span><span class="w"> </span><span class="na">class=</span><span class="s">"dropdown-divider"</span><span class="nt">&gt;</span>
</span><span class="hll"><span class="w">                </span><span class="nt">&lt;/li&gt;</span>
</span><span class="hll"><span class="w">                </span><span class="nt">&lt;li&gt;</span>
</span><span class="hll"><span class="w">                    </span><span class="nt">&lt;a</span><span class="w"> </span><span class="na">class=</span><span class="s">"dropdown-item"</span><span class="w"> </span><span class="na">asp-area=</span><span class="s">""</span><span class="w"> </span><span class="na">asp-page=</span><span class="s">"/Admin/ManageUsers"</span><span class="nt">&gt;</span>Felhasználók<span class="nt">&lt;/a&gt;</span>
</span><span class="hll"><span class="w">                </span><span class="nt">&lt;/li&gt;</span>
</span><span class="hll"><span class="w">            </span><span class="nt">&lt;/ul&gt;</span>
</span><span class="hll"><span class="w">        </span><span class="nt">&lt;/li&gt;</span>
</span><span class="hll"><span class="w">    </span>}
</span><span class="nt">&lt;/ul&gt;</span>
<span class="nt">&lt;partial</span><span class="w"> </span><span class="na">name=</span><span class="s">"_LoginPartial"</span><span class="w"> </span><span class="nt">/&gt;</span>
</code></pre></div>
</li>
<li>
<p>Amint látható az adminisztrációs oldalakat egy <code>Admin</code> könyvtárba szervezzük, hogy egyszerűbb legyen majd az elérés korlátozása. Ezen felül figyeljük meg, hogy ezt a menüpontot csak akkor érheti el a felhasználó, ha ő is benne van az <code>Admin</code> szerepkörben. Hozzuk is létre a szükséges oldalakat a <code>Pages/Admin</code> könyvtárban.</p>
<ul>
<li>Pages/Admin/ManageBooks.cshtml</li>
<li>Pages/Admin/ManageCategories.cshtml</li>
<li>Pages/Admin/ManageUsers.cshtml</li>
</ul>
<details class="success">
<summary>Admin menüpontok</summary>
<figure>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="images/admin-menu-items.png" data-desc-position="bottom"><img alt="alt text" src="images/admin-menu-items.png"></a></p>
<figcaption>
<p>Adminisztrációs menüpontok</p>
</figcaption>
</figure>
</details>
</li>
<li>
<p>Ha így kipróbáljuk az alkalmazást egy nem adminisztrátor felhasználóval, akkor a menüpontot nem fogjuk látni, de ha ismerjük az URL-t akkor az oldal betölt. Ez egy komoly hiba, mert mindig védeni kell a backend oldali funkciót is, az nem ad biztonságot, hogy a felülten elrejtjük a linket.</p>
</li>
<li>
<p>Állítsuk be, hogy a <code>Pages/Amin</code> könyvtár tartalmát csak <code>Admin</code> szerepkörben lévő felhasználók érhessék el. Ehhez létrehozunk egy policy-t, ami megköveteli, hogy a felhasználó benne legyen az adott szerepkörben. Ehhez az alábbi kódrészletet kell beletenni a <code>Program.cs</code>-be a <code>RequestContext</code> DI-ba regisztrálása után.</p>
<div class="highlight"><span class="filename">Program.cs</span><pre><span></span><code><span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddAuthorizationBuilder</span><span class="p">()</span>
<span class="w">    </span><span class="p">.</span><span class="n">AddPolicy</span><span class="p">(</span><span class="s">"RequireAdminRole"</span><span class="p">,</span><span class="w"> </span><span class="n">policy</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">policy</span><span class="p">.</span><span class="n">RequireRole</span><span class="p">(</span><span class="s">"Admin"</span><span class="p">));</span>

<span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddRazorPages</span><span class="p">(</span><span class="n">options</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">options</span><span class="p">.</span><span class="n">Conventions</span><span class="p">.</span><span class="n">AuthorizeFolder</span><span class="p">(</span><span class="s">"/Admin"</span><span class="p">,</span><span class="w"> </span><span class="s">"RequireAdministratorRole"</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>
</li>
<li>
<p>Hasonló konvenció alapú jogosultság kezelést a <a href="https://learn.microsoft.com/en-us/aspnet/core/security/authorization/razor-pages-authorization?view=aspnetcore-10.0">hivatalos dokumentációban</a> tekinthetjük meg.</p>
</li>
<li>
<p>Így már az oldalt nem lehet elérni, de a login oldalra sem tud átirányítani, mert azt nem a megfelelő helyen keresi, így 404-es hibaoldalt kapunk. A megoldáshoz a <code>Program.cs</code>-ben az <code>AddRazorPages</code> (amit az előbb módosítottunk) mögé illesszük be az alábbi kódot.</p>
<div class="highlight"><span class="filename">Program.cs</span><pre><span></span><code><span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">ConfigureApplicationCookie</span><span class="p">(</span><span class="n">options</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">options</span><span class="p">.</span><span class="n">Cookie</span><span class="p">.</span><span class="n">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">".IdentityNet10.Auth"</span><span class="p">;</span>
<span class="w">    </span><span class="n">options</span><span class="p">.</span><span class="n">Cookie</span><span class="p">.</span><span class="n">HttpOnly</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">;</span>
<span class="w">    </span><span class="n">options</span><span class="p">.</span><span class="n">Cookie</span><span class="p">.</span><span class="n">SecurePolicy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CookieSecurePolicy</span><span class="p">.</span><span class="n">Always</span><span class="p">;</span>
<span class="w">    </span><span class="n">options</span><span class="p">.</span><span class="n">Cookie</span><span class="p">.</span><span class="n">SameSite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SameSiteMode</span><span class="p">.</span><span class="n">Lax</span><span class="p">;</span><span class="w"> </span><span class="c1">// or Strict for pure server‑rendered sites</span>

<span class="w">    </span><span class="n">options</span><span class="p">.</span><span class="n">LoginPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"/Identity/Account/Login"</span><span class="p">;</span>
<span class="w">    </span><span class="n">options</span><span class="p">.</span><span class="n">LogoutPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"/Identity/Account/Logout"</span><span class="p">;</span>
<span class="w">    </span><span class="n">options</span><span class="p">.</span><span class="n">AccessDeniedPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"/Identity/Account/AccessDenied"</span><span class="p">;</span>

<span class="w">    </span><span class="n">options</span><span class="p">.</span><span class="n">SlidingExpiration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">;</span>
<span class="w">    </span><span class="n">options</span><span class="p">.</span><span class="n">ExpireTimeSpan</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TimeSpan</span><span class="p">.</span><span class="n">FromMinutes</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>
</li>
</ol>
<h2 id="onallo-feladat-profil-oldalak-opcionalis">Önálló feladat: Profil oldalak (opcionális)<a class="headerlink" href="#onallo-feladat-profil-oldalak-opcionalis" title="Permanent link">¶</a></h2>
<div class="admonition example">
<p class="admonition-title">Önálló feladat: Profil oldalak</p>
<ul>
<li>Generálja le a profil adatokat szerkesztő oldalakat is, ahol a felhasználó meg tudja változtatni a személyed adatait, email címét, jelszavát, vagy a 2FA adatokat.
<a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="images/manage-user-profile.png" data-desc-position="bottom"><img alt="Manage user profile" src="images/manage-user-profile.png"></a></li>
</ul>
</div>
<h3 id="3rd-party-login">3<sup>rd</sup> party login<a class="headerlink" href="#3rd-party-login" title="Permanent link">¶</a></h3>
<h4 id="app-registration-gui">App registration (GUI)<a class="headerlink" href="#app-registration-gui" title="Permanent link">¶</a></h4>
<p>Nagy valószínűséggel ez a megoldás a BME tenantban nem használható, mert részlegesen letiltották.</p>
<ol>
<li>
<p>Ahhoz, hogy Microsoft Accounttal is be lehessen lépni be kell regisztrálnunk az alkalmazást az <a href="https://portal.azure.com/#blade/Microsoft_AAD_RegisteredApps/ApplicationsListBlade">Azure portálon</a>, ahol a fent található <em>Új regisztráció</em>-ra kattintva tudunk új alkalmazást regisztrálni. Ez láthatjuk az alábbi ábrán.</p>
<figure>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="images/azure-app-registrations.png" data-desc-position="bottom"><img alt="Azure app registrations" src="images/azure-app-registrations.png"></a></p>
<figcaption>
<p>Azure App registrations</p>
</figcaption>
</figure>
</li>
<li>
<p>Adjuk meg az alkalmazás adatait (ha elérhető a webes felület). Érdemes megpróbálni a közvetlen linket, mert akkor lehet, hogy engedi: <a href="https://portal.azure.com/#view/Microsoft_AAD_RegisteredApps/CreateApplicationBlade/quickStartType~/null/isMSAApp~/false">Új alkalmazás regisztrálás</a></p>
<ul>
<li>Alkalmazás neve</li>
<li>Kik érhetik el az alkalmazást</li>
<li>Milyen URL-re kell visszairányítani a bejelentkezés után. Ide az alkalmazás URL + a /signin-microsoft -ot kell megadni. <a href="http://localhost:5001/signin-microsoft">http://localhost:5001/signin-microsoft</a> és a <a href="https://localhost:44329/signin-microsoft">https://localhost:44329/signin-microsoft</a> fontos, hogy a HTTPS-es URL-t is megadjuk!</li>
<li>Végül kattintsunk a Regisztráció gombra.</li>
</ul>
<figure>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="images/create-new-app-registration.png" data-desc-position="bottom"><img alt="Create new app registration" src="images/create-new-app-registration.png"></a></p>
<figcaption>
<p>Új alkalmazás regisztráció</p>
</figcaption>
</figure>
</li>
<li>
<p>Majd készítsünk hozzá privát kulcsot is</p>
<figure>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="images/app-registration-secrects.png" data-desc-position="bottom"><img alt="App registration secrets" src="images/app-registration-secrects.png"></a></p>
<figcaption>
<p>App registration beállítása</p>
</figcaption>
</figure>
</li>
</ol>
<h4 id="app-registration-powershell">App registration (powershell)<a class="headerlink" href="#app-registration-powershell" title="Permanent link">¶</a></h4>
<p>Sajnálatos módon a BME Azure-ban ezt a webes felületet már nem lehet elérni, kis trükközéssel még a létrehozás kijátszható, de már beállítani nem tudjuk.</p>
<ol>
<li>Indítsunk el egy <strong>VS Code</strong>-ot</li>
<li>
<p>Telepítsük fel az <strong>Azure Application Registration</strong> extensiont, majd indítsuk újra a VS Code-ot.</p>
<figure>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="images/vs-extension-azure-app-registration.png" data-desc-position="bottom"><img alt="Azure Application Registration extension" src="images/vs-extension-azure-app-registration.png"></a></p>
<figcaption>
<p>Azure Application Registration extension</p>
</figcaption>
</figure>
</li>
<li>
<p>Ezt követően nyissuk meg bal oldalon a kiegészítőt, és lent az <em>Application Registration</em> rész kell nekünk.</p>
</li>
<li>
<p>Ha nincs feltelepítve, akkor telepísük fel az <em>Azure CLI</em>-t. Ehhez a terminal ablakban futtassuk az alábbi parancsot.</p>
<div class="highlight"><pre><span></span><code><span class="n">winget</span> <span class="n">install</span> <span class="p">-</span><span class="o">-exact</span> <span class="p">-</span><span class="n">-id</span> <span class="n">Microsoft</span><span class="p">.</span><span class="n">AzureCLI</span>
</code></pre></div>
</li>
<li>
<p>Lépjünk be <em>Azure CLI</em>-vel, ehhez kérni fogja a TenantId-t ami <strong>6a3548ab-7570-4271-91a8-58da00697029</strong>. Illetve fel fog dobni egy böngésző ablakot a bejelentkezéshez, ahol meg kell adni a BME-s felhasználót.</p>
</li>
<li>
<p>Belépés után már az <em>Application Registration</em> mellett a <strong>+</strong> gombra kattinva létre is tudjuk hozni az új regisztrációt.</p>
<ul>
<li>Először válasszuk ki, hogy kik léphetnek be. Válasszuk a <em>Multi Tenants</em> opciót.
    <a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="images/vs-code-app-registratoion-1.png" data-desc-position="bottom"><img alt="VS Code App registration 1" src="images/vs-code-app-registratoion-1.png"></a>
    /// caption
    Bejelentkezési mód megadása
    ///</li>
<li>Majd adjuk meg az alkalmazás nevét.
    <a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="images/vs-code-app-registration-2.png" data-desc-position="bottom"><img alt="VS Code App registration 2" src="images/vs-code-app-registration-2.png"></a>
    /// caption
    Application név megadása
    ///</li>
<li>Végül frissítsük az <em>Application Registration</em> listát.</li>
</ul>
</li>
<li>
<p>Ha mindent jól csináltuk a listában le tudjuk nyitni az új App registration-t, ahonnan a <em>ClientId</em>-ra lesz szükségünk, illetve be kell állítania <em>Redirect URIs</em>-t és a Credentials alatt található Client Secrets-ben kell egy új secretet létrehozni.</p>
<figure>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="images/vs-code-app-registration-3.png" data-desc-position="bottom"><img alt="VS Code App registration 3" src="images/vs-code-app-registration-3.png"></a></p>
<figcaption>
<p>Regisztrált alkalmazás Azure-ben.</p>
</figcaption>
</figure>
</li>
<li>
<p>A <em>Redirect URIs</em> alatt a <em>Web</em> jobb klikk -&gt; Add és adjuk meg a <em><a href="https://localhost:44329/signin-microsoft">https://localhost:44329/signin-microsoft</a></em> URI-t.</p>
</li>
<li>
<p>Majd hozzuk létre az új secretet. (Client Secrets -&gt; jobb klikk -&gt; Add)</p>
<ul>
<li>Első lépésként description-t kér, ahova írjuk be a 'Login-secret'-et vagy bármit ez csak egy leírás, hogy több titok esetén tudjuk melyiket mire használjuk.</li>
<li>Második lépésként pedig a lejárat dátumát kell megadni.</li>
</ul>
<div class="admonition danger">
<p class="admonition-title">Secret értéke csak a létrehozáskor érhető el</p>
<p>A secret értéke automatikusan a vágólapra került létrehozáskor és később az értékét már nem lehet kiolvasni! Így mensük el, hogy később ne kelljen újat létrehozni!</p>
</div>
</li>
<li>
<p>Törölni is tudjuk a titkokat, vagy akár az egész App registration-t, csak arra kell figyelni, hogy ha a jobb klikk -&gt; delete-re kattintunk akkor utána a jobb alsó sarokban rákérdez, hogy valóban törölni szeretnénk-e. Ott kell megerősíteni a törlést.</p>
</li>
</ol>
<h3 id="ms-auth-hozzaadasa-a-projekthez">MS Auth hozzáadása a projekthez<a class="headerlink" href="#ms-auth-hozzaadasa-a-projekthez" title="Permanent link">¶</a></h3>
<p>Belépéshez szükségünk van egy harmadik fél által nyújtott authentikációs mechanizmusra. A legtöbb ilyen megoldás egyszerűen egy middleware beékelését jelenti a rendszerbe, ahol a külső providerrel kommunikál.</p>
<ol>
<li>A Microsoft Account használatához a <code>Microsoft.AspNetCore.Authentication.MicrosoftAccount</code> NuGet packaget kell feltelepíteni a Webes projekthez. Ügyeljünk, hogy a megfelelő verziót válasszuk belőle, ami az ASP.NET Core verzióval megegyezik.</li>
<li>
<p>Majd módosítsuk a DI konfigurációt, hogy az authentikáció Microsoft Accountot (is) használjon. Ehhez másoljuk be az alábbi kódrészletet a <code>Program.cs</code>-be az <code>AddIdentity</code> után.</p>
<div class="highlight"><span class="filename">Program.cs</span><pre><span></span><code><span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddAuthentication</span><span class="p">().</span><span class="n">AddMicrosoftAccount</span><span class="p">(</span><span class="n">options</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">options</span><span class="p">.</span><span class="n">ClientId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">Configuration</span><span class="p">[</span><span class="s">"Authentication:Microsoft:ClientId"</span><span class="p">]</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InvalidOperationException</span><span class="p">(</span><span class="s">"Microsoft ClientId not found in configuration."</span><span class="p">);</span>
<span class="w">    </span><span class="n">options</span><span class="p">.</span><span class="n">ClientSecret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">Configuration</span><span class="p">[</span><span class="s">"Authentication:Microsoft:ClientSecret"</span><span class="p">]</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InvalidOperationException</span><span class="p">(</span><span class="s">"Microsoft ClientSecret not found in configuration."</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>
</li>
<li>
<p>A kódba nem égettük bele a <code>ClientId</code>-t és a <code>ClientSecret</code>-et (ezeket hoztuk létre az App registrationnél), hanem az <code>appsettings.Developement.json</code>-ből olvassuk ki. Ezért oda fel kell venni az alábbi kódrészletet.<br>
<strong>Fontos</strong>, hogy a <code>ClientId</code> és <code>ClientSecret</code> értéket a saját App registration-ből kell venni.</p>
<div class="highlight"><span class="filename">appsettings.Developement.json</span><pre><span></span><code><span class="nt">"Authentication"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">"Microsoft"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">"ClientId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"cfe7..."</span><span class="p">,</span>
<span class="w">    </span><span class="nt">"ClientSecret"</span><span class="p">:</span><span class="w"> </span><span class="s2">"9f..."</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</li>
<li>
<p>Ha elindítjuk az alkalmazást, akkor a Login oldalon megjelenik a külső hitelesítés szolgáltatóknál a Microsoft gomb. Ha rákattinva nem történik semmi, akkor létre kell hozni Scaffoldinggal ay <code>ExternalLogin</code> oldalt.</p>
<div class="highlight"><pre><span></span><code><span class="n">dotnet</span> <span class="n">aspnet-codegenerator</span> <span class="n">identity</span> <span class="n">-dc</span> <span class="n">BookShop</span><span class="p">.</span><span class="n">Dal</span><span class="p">.</span><span class="n">BookShopDbContext</span> <span class="n">-u</span> <span class="n">BookShop</span><span class="p">.</span><span class="n">Dal</span><span class="p">.</span><span class="n">Entities</span><span class="p">.</span><span class="n">ApplicationUser</span>  <span class="p">-</span><span class="n">-files</span> <span class="s2">"Account.ExternalLogin"</span>
</code></pre></div>
<div class="admonition failure">
<p class="admonition-title">Hibásan generált fájlok törlése</p>
<p>Ügyeljünk rá, hogy ilyenkor a <code>Data</code> könyvtárat törüljük kell és a <code>Program.cs</code>-ben ha mégegszer regisztrálja a DbContext-et akkor azt is töröljük.</p>
</div>
</li>
<li>
<p>Ezt követően a Microsoft gombra kattinva már átirányít a Microsoft fiókos belépés oldalára, ahol a BME-s felhasználónkkal tudunk belépni.</p>
<figure>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="images/microsoft-login-permissions.png" data-desc-position="bottom"><img alt="Ask for permission" src="images/microsoft-login-permissions.png"></a></p>
<figcaption>
<p>Szükséges engedélyek bekérése</p>
</figcaption>
</figure>
</li>
<li>
<p>Ha beleegyeztünk a jogosultságok megadásába, akkor visszairányít az alkalmazásunkba az <code>ExternalLogin</code>, ahol már elérjük a külső azonosításból rendelkezésre álló adatokat mint az email cím.</p>
<figure>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="images/microsoft-login-create-new-account.png" data-desc-position="bottom"><img alt="Create new external account" src="images/microsoft-login-create-new-account.png"></a></p>
<figcaption>
<p>ExternalLogin oldal betöltése</p>
</figcaption>
</figure>
</li>
<li>
<p>Ha rákattintunk a Register gombra, akkor viszont elszáll a kód, mert a <code>DisplayName</code> nincs megadva.</p>
</li>
</ol>
<h2 id="onallo-feladat-externallogin-kiegeszitese">Önálló feladat: ExternalLogin kiegészítése<a class="headerlink" href="#onallo-feladat-externallogin-kiegeszitese" title="Permanent link">¶</a></h2>
<div class="admonition example">
<p class="admonition-title">Önálló feladat: DisplayName felvétele az <code>ExternalLogin</code> oldalra</p>
<ul>
<li>A kód behindban az InputModel-be vegye fel a <code>DisplayName</code>-et</li>
<li>Az <code>OnPostConfirmationAsync</code> állítsa be a <code>user</code>-et a <code>DisplayName</code>-et.</li>
<li>Módosítsa az <code>ExternalLogin.cstml</code> oldal kódját úgy, hogy az kötelezően bekérje a <code>DisplayName</code> értékét is.</li>
</ul>
</div>
<figure>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="images/External-login-display-name.png" data-desc-position="bottom"><img alt="External login display name" src="images/External-login-display-name.png"></a></p>
<figcaption>
<p>A külső belépés után bekéri a felhasználó nevét is.</p>
</figcaption>
</figure>
<details class="tip">
<summary>Segítség</summary>
<ul>
<li>
<p>Input modell kiegészítése
    </p><div class="highlight"><span class="filename">ExternalLogin.cshtml.cs - Input model</span><pre><span></span><code><span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">InputModel</span>
<span class="p">{</span>
<span class="w">    </span><span class="na">[Required]</span>
<span class="w">    </span><span class="na">[EmailAddress]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="n">Email</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>

<span class="hll"><span class="w">    </span><span class="na">[Required]</span>
</span><span class="hll"><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="n">DisplayName</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
</span><span class="p">}</span>
</code></pre></div><p></p>
</li>
<li>
<p>DisplayName elmentése
    </p><div class="highlight"><span class="filename">ExternalLogin.cshtml.cs - OnPostConfirmationAsync</span><pre><span></span><code><span class="k">public</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="n">Task</span><span class="o">&lt;</span><span class="n">IActionResult</span><span class="o">&gt;</span><span class="w"> </span><span class="n">OnPostConfirmationAsync</span><span class="p">(</span><span class="kt">string</span><span class="w"> </span><span class="n">returnUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">null</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">returnUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">returnUrl</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="n">Url</span><span class="p">.</span><span class="n">Content</span><span class="p">(</span><span class="s">"~/"</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// Get the information about the user from the external login provider</span>
<span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="n">_signInManager</span><span class="p">.</span><span class="n">GetExternalLoginInfoAsync</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">info</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">null</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">ErrorMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"Error loading external login information during confirmation."</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nf">RedirectToPage</span><span class="p">(</span><span class="s">"./Login"</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">ReturnUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">returnUrl</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ModelState</span><span class="p">.</span><span class="n">IsValid</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateUser</span><span class="p">();</span>
<span class="hll"><span class="w">        </span><span class="n">user</span><span class="p">.</span><span class="n">DisplayName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Input</span><span class="p">.</span><span class="n">DisplayName</span><span class="p">;</span>
</span>
<span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="n">_userStore</span><span class="p">.</span><span class="n">SetUserNameAsync</span><span class="p">(</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">Input</span><span class="p">.</span><span class="n">Email</span><span class="p">,</span><span class="w"> </span><span class="n">CancellationToken</span><span class="p">.</span><span class="n">None</span><span class="p">);</span>
<span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="n">_emailStore</span><span class="p">.</span><span class="n">SetEmailAsync</span><span class="p">(</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">Input</span><span class="p">.</span><span class="n">Email</span><span class="p">,</span><span class="w"> </span><span class="n">CancellationToken</span><span class="p">.</span><span class="n">None</span><span class="p">);</span>

<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="n">_userManager</span><span class="p">.</span><span class="n">CreateAsync</span><span class="p">(</span><span class="n">user</span><span class="p">);</span>
</code></pre></div><p></p>
</li>
<li>
<p>Felület kiegészítése
    </p><div class="highlight"><span class="filename">ExternalLogin.cshtml</span><pre><span></span><code><span class="nt">&lt;div</span><span class="w"> </span><span class="na">class=</span><span class="s">"form-floating mb-3"</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;input</span><span class="w"> </span><span class="na">asp-for=</span><span class="s">"Input.DisplayName"</span><span class="w"> </span><span class="na">class=</span><span class="s">"form-control"</span><span class="w"> </span><span class="na">placeholder=</span><span class="s">"Please enter your name."</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;label</span><span class="w"> </span><span class="na">asp-for=</span><span class="s">"Input.DisplayName"</span><span class="w"> </span><span class="na">class=</span><span class="s">"form-label"</span><span class="nt">&gt;&lt;/label&gt;</span>
<span class="w">    </span><span class="nt">&lt;span</span><span class="w"> </span><span class="na">asp-validation-for=</span><span class="s">"Input.DisplayName"</span><span class="w"> </span><span class="na">class=</span><span class="s">"text-danger"</span><span class="nt">&gt;&lt;/span&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre></div><p></p>
</li>
</ul>
</details>
<h2 id="gdpr">GDPR<a class="headerlink" href="#gdpr" title="Permanent link">¶</a></h2>
<p>Az ASP.NET a GDPR szabályozás betartásához is nyújt segítséget. Az alábbi linken például látható, hogy milyen egyszerűen lehet a sütik használatát elfogadtattni.</p>
<p><a href="https://learn.microsoft.com/en-us/aspnet/core/security/gdpr?view=aspnetcore-10.0">ASP.NET támogatás a GDPR-hoz</a></p>
<h2 id="migraciok-automatikus-futtatasa">Migrációk automatikus futtatása<a class="headerlink" href="#migraciok-automatikus-futtatasa" title="Permanent link">¶</a></h2>
<details class="tip">
<summary>Middleware adatbázis migrációk futtatásához development módban</summary>
<p>Fejlesztés közben gyakran módosul az Entity Framework modell és ilyenkor a migráció generálása után kézzel kell kiadni az <code>Update-Database</code> parancsot, ha migrációs hiba miatt nem indul az alkalmazást. Ebben tud segíteni a <code>UseMigrationsEndPoint</code>, melynek használatához a <code>Microsoft.AspNetCore.Diagnostics.EntityFrameworkCore</code> NuGet package-et kell hozzáadni a Webes projekthez.</p>
<div class="highlight"><span class="filename">Program.cs</span><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">app</span><span class="p">.</span><span class="n">Environment</span><span class="p">.</span><span class="n">IsDevelopment</span><span class="p">())</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Processes requests to execute migrations operations</span>
<span class="w">    </span><span class="n">app</span><span class="p">.</span><span class="n">UseMigrationsEndPoint</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
</details>
  <hr>
  <div class="md-source-file">
    <span class="md-source-file__fact"> <span class="md-icon" title="Utolsó frissítés"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1-2.1-2M12.5 7v5.2l4 2.4-1 1L11 13V7h1.5M11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2v1.8Z">
          </path>
        </svg>
      </span>
      <span title="2026. február 12. 13:31:10">
        <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago" title="2026. február 12. 13:31:10 CET"><span class="timeago" datetime="2026-02-12T13:31:10+01:00" locale="hu"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date" title="2026. február 12. 13:31:10 CET">2026-02-12</span>
      </span>
    </span>

    

    <span class="md-source-file__fact">
      <span class="md-icon" title="Szerzők">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33.85 0 1.71.11 2.5.33 1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2Z">
          </path>
        </svg>
      </span>
      <span>Szerzők</span>
      <nav></nav>      
    </span>
  </div>




                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  Vissza a tetejére
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright © BME VIK AUT
    </div>
  
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../..", "features": ["content.code.copy", "content.code.select", "navigation.tabs", "navigation.top", "search.suggest", "content.action.edit", "toc.follow"], "search": "../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "V\u00e1g\u00f3lapra m\u00e1solva", "clipboard.copy": "M\u00e1sol\u00e1s v\u00e1g\u00f3lapra", "search.result.more.one": "1 tov\u00e1bbi tal\u00e1lat az oldalon", "search.result.more.other": "# tov\u00e1bbi tal\u00e1lat az oldalon", "search.result.none": "Nincs tal\u00e1lat", "search.result.one": "1 egyez\u0151 dokumentum", "search.result.other": "# egyez\u0151 dokumentum", "search.result.placeholder": "Keres\u00e9shez \u00edrj ide valamit", "search.result.term.missing": "\u00dcres", "select.version": "Verzi\u00f3v\u00e1lt\u00e1s"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
        <script src="../../../js/timeago.min.js"></script>
      
        <script src="../../../js/timeago_mkdocs_material.js"></script>
      
    
  
<script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(()=>{ lightbox.reload(); });
</script></body></html>